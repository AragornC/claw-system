<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0f1419">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AI交易看板">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="app-icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="app-icon.svg">
  <title>AI 交易机器人集成看板</title>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root { --bg: #0f1419; --card: #1a2332; --border: #2d3a4f; --text: #e6edf3; --muted: #8b949e; --green: #3fb950; --red: #f85149; --yellow: #d29922; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 16px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }
    h1 { font-size: 1.18rem; margin: 0 0 2px; }
    h2 { font-size: 0.92rem; margin: 0; font-weight: 600; }
    .app-shell { max-width: 1280px; margin: 0 auto; }
    .app-topbar { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
    .app-subtitle { color: var(--muted); font-size: 0.76rem; }
    .top-actions { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .nav-btn { border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: var(--text); border-radius: 999px; padding: 5px 10px; font-size: 0.74rem; cursor: pointer; }
    .nav-btn.active { border-color: rgba(88,166,255,0.6); color: #58a6ff; background: rgba(88,166,255,0.14); }
    .assistant-nav { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .view-panel { display: none; }
    .view-panel.active { display: block; }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .panel-card { border: 1px solid var(--border); border-radius: 12px; background: var(--card); padding: 10px; }
    .card-title-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .card-action { border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: #58a6ff; border-radius: 999px; padding: 3px 9px; font-size: 0.68rem; cursor: pointer; }
    .card-action:hover { border-color: rgba(88,166,255,0.65); color: var(--text); }
    .position-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
    .position-item { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.14); padding: 8px; }
    .position-item.long { border-color: rgba(63,185,80,0.5); background: rgba(63,185,80,0.07); }
    .position-item.short { border-color: rgba(248,81,73,0.5); background: rgba(248,81,73,0.07); }
    .position-top { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 4px; }
    .position-title { font-size: 0.76rem; color: var(--text); font-weight: 600; }
    .position-meta { font-size: 0.7rem; color: var(--muted); }
    .position-kv { display: grid; grid-template-columns: auto 1fr; gap: 2px 8px; font-size: 0.7rem; }
    .position-kv .k { color: var(--muted); }
    .position-kv .v { color: var(--text); }
    .strategy-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 8px; margin-bottom: 8px; }
    .metric-tile { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.14); padding: 8px; }
    .metric-label { font-size: 0.68rem; color: var(--muted); margin-bottom: 2px; }
    .metric-value { font-size: 0.88rem; color: var(--text); font-weight: 600; }
    .strategy-note { font-size: 0.72rem; color: var(--muted); }
    .timeline-list { max-height: 330px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .timeline-item { border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: rgba(0,0,0,0.14); }
    .timeline-head { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 3px; align-items: center; }
    .timeline-tag { font-size: 0.64rem; border-radius: 999px; padding: 1px 7px; border: 1px solid var(--border); color: var(--text); }
    .timeline-tag.signal { border-color: rgba(88,166,255,0.55); color: #58a6ff; }
    .timeline-tag.order { border-color: rgba(63,185,80,0.55); color: var(--green); }
    .timeline-tag.risk { border-color: rgba(248,81,73,0.55); color: var(--red); }
    .timeline-tag.info { border-color: rgba(210,153,34,0.55); color: var(--yellow); }
    .timeline-ts { font-size: 0.66rem; color: var(--muted); white-space: nowrap; }
    .timeline-main { font-size: 0.75rem; color: var(--text); }
    .timeline-sub { font-size: 0.68rem; color: var(--muted); margin-top: 2px; }
    .ai-chat-wrap { margin-top: 10px; }
    .ai-quick { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    .ai-quick-btn { border: 1px dashed var(--border); border-radius: 999px; background: rgba(0,0,0,0.18); color: var(--muted); font-size: 0.68rem; padding: 3px 9px; cursor: pointer; }
    .ai-quick-btn:hover { border-color: rgba(88,166,255,0.6); color: #58a6ff; }
    .ai-chat-box { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.16); padding: 8px; min-height: 180px; max-height: 330px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
    .ai-msg { max-width: min(90%, 760px); border-radius: 10px; padding: 7px 9px; font-size: 0.74rem; line-height: 1.4; white-space: pre-wrap; word-break: break-word; }
    .ai-msg.user { align-self: flex-end; background: rgba(88,166,255,0.16); border: 1px solid rgba(88,166,255,0.5); }
    .ai-msg.bot { align-self: flex-start; background: rgba(63,185,80,0.12); border: 1px solid rgba(63,185,80,0.45); }
    .ai-input-row { margin-top: 8px; display: flex; gap: 8px; }
    .ai-input-row input { flex: 1; min-width: 0; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.2); color: var(--text); padding: 8px 10px; font-size: 0.78rem; }
    .ai-input-row button { border: 1px solid rgba(88,166,255,0.55); border-radius: 8px; background: rgba(88,166,255,0.15); color: #58a6ff; padding: 8px 12px; font-size: 0.76rem; cursor: pointer; }
    .history-summary { margin-bottom: 8px; color: var(--muted); font-size: 0.76rem; }
    #orders-table-wrap { width: 100%; border-collapse: collapse; font-size: 0.79rem; }
    #orders-table-wrap th, #orders-table-wrap td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    #orders-table-wrap th { color: var(--muted); font-weight: 600; position: sticky; top: 0; background: var(--card); }
    #orders-table-wrap tr:hover { background: rgba(255,255,255,0.03); }
    .chart-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    .chart-header .meta { color: var(--muted); font-size: 0.875rem; margin: 0; }
    .chart-header select { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; font-size: 0.875rem; cursor: pointer; }
    #chart-wrap { height: clamp(300px, 52vh, 460px); margin-bottom: 16px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative; touch-action: manipulation; }
    #detail-popover { display: none; position: absolute; z-index: 100; min-width: 320px; max-width: 420px; max-height: min(75vh, 380px); overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); font-size: 0.8125rem; }
    #detail-popover.visible { display: block; }
    #detail-popover .popover-close { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; line-height: 1; padding: 4px; }
    #detail-popover .popover-close:hover { color: var(--text); }
    #detail-popover .popover-ts { color: var(--muted); margin-bottom: 8px; padding-right: 24px; }
    #detail-popover .popover-row { margin-bottom: 6px; }
    #detail-popover .popover-label { color: var(--muted); margin-right: 6px; }
    #detail-popover .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
    #detail-popover .badge.yes { background: rgba(63,185,80,0.2); color: var(--green); }
    #detail-popover .badge.no { background: rgba(248,81,73,0.2); color: var(--red); }
    #detail-popover .badge.dry { background: rgba(210,153,34,0.2); color: var(--yellow); }
    #detail-popover .reason { word-break: break-word; margin-top: 4px; color: var(--text); }
    #detail-popover .popover-section { margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--border); }
    #detail-popover .popover-section-title { color: var(--muted); font-size: 0.75rem; margin-bottom: 4px; }
    #detail-popover .news-link { display: block; font-size: 0.75rem; margin-top: 4px; color: #58a6ff; text-decoration: none; }
    #detail-popover .news-link:hover { text-decoration: underline; }
    #detail-popover .news-list-wrap { max-height: 160px; overflow-y: auto; margin-top: 4px; -webkit-overflow-scrolling: touch; }
    #detail-popover .plan-reason-block { margin-top: 4px; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.75rem; color: var(--text); word-break: break-word; }
    #detail-popover .algo-line { font-size: 0.75rem; margin-top: 2px; color: var(--text); word-break: break-word; }
    #detail-popover .calc-grid { display: grid; grid-template-columns: auto 1fr; gap: 2px 12px; font-size: 0.75rem; margin-top: 4px; }
    #detail-popover .calc-k { color: var(--muted); }
    #detail-popover .calc-v { color: var(--text); text-align: right; }
    #detail-popover .strategy-block { margin-top: 6px; padding: 6px 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: 0.75rem; }
    #detail-popover .strategy-name { color: var(--yellow); font-weight: 600; margin-bottom: 4px; }
    #detail-popover .strategy-indicators { color: var(--muted); margin-bottom: 4px; line-height: 1.5; }
    #detail-popover .strategy-apply { color: var(--text); border-left: 2px solid var(--border); padding-left: 8px; }
    #detail-popover .popover-pin-hint { font-size: 0.7rem; color: var(--muted); margin-top: 6px; }
    #detail-popover .chart-lines-hint { font-size: 0.7rem; color: var(--green); margin-top: 6px; }
    #detail-popover .calc-k.clickable { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    #detail-popover .calc-k.clickable:hover { color: var(--text); }
    #indicator-hover-tooltip { display: none; position: fixed; z-index: 250; max-width: 280px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); font-size: 0.75rem; pointer-events: none; }
    #indicator-hover-tooltip.visible { display: block; }
    #indicator-hover-tooltip.pinned { pointer-events: auto; }
    #indicator-hover-tooltip .calc-tt-title { color: var(--yellow); font-weight: 600; margin-bottom: 6px; }
    #indicator-hover-tooltip .calc-tt-value { color: var(--green); margin-bottom: 6px; }
    #indicator-hover-tooltip .calc-tt-steps { margin-bottom: 6px; }
    #indicator-hover-tooltip .calc-tt-step { margin: 2px 0; padding-left: 4px; border-left: 2px solid var(--border); color: var(--text); }
    #indicator-hover-tooltip .calc-tt-formula { background: rgba(0,0,0,0.3); padding: 6px 8px; border-radius: 4px; font-family: ui-monospace, monospace; font-size: 0.7rem; color: var(--muted); margin-bottom: 6px; word-break: break-all; }
    #indicator-hover-tooltip .calc-tt-chart { color: var(--green); font-size: 0.7rem; margin-bottom: 6px; }
    #indicator-hover-tooltip .calc-tt-minichart { width: 256px; height: 72px; margin: 6px 0; border-radius: 4px; overflow: hidden; background: rgba(0,0,0,0.2); }
    #indicator-hover-tooltip .calc-tt-close { display: none; margin-top: 6px; padding: 4px 10px; font-size: 0.7rem; background: var(--border); border: none; border-radius: 4px; color: var(--text); cursor: pointer; }
    #indicator-hover-tooltip.pinned .calc-tt-close { display: inline-block; }
    #detail-popover .logic-result-block { margin-top: 6px; padding: 8px; background: rgba(63,185,80,0.08); border-radius: 4px; border-left: 3px solid var(--green); font-size: 0.75rem; line-height: 1.5; }
    #detail-popover .summary-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
    #detail-popover .summary-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 999px; font-size: 0.72rem; border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: var(--text); }
    #detail-popover .summary-chip.k { color: var(--muted); font-size: 0.68rem; }
    #detail-popover .decision-tree-wrap { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
    #detail-popover .decision-tree-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    #detail-popover .decision-tree-title { color: var(--text); font-weight: 600; font-size: 0.82rem; }
    #detail-popover .decision-tree-sub { color: var(--muted); font-size: 0.7rem; }
    #detail-popover .decision-tree-grid { display: grid; grid-template-columns: 1.15fr 0.85fr; gap: 10px; }
    #detail-popover .decision-tree-main { min-width: 0; }
    #detail-popover .decision-side { min-width: 0; display: flex; flex-direction: column; gap: 8px; }
    #detail-popover .decision-tree { display: flex; align-items: stretch; gap: 6px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
    #detail-popover .dt-node { min-width: 210px; flex: 0 0 210px; border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.16); padding: 8px; opacity: 0; transform: translateY(8px); animation: dtNodeIn 0.28s ease forwards; animation-delay: calc(var(--i) * 70ms); }
    #detail-popover .dt-node.pass { border-color: rgba(63,185,80,0.5); background: rgba(63,185,80,0.08); }
    #detail-popover .dt-node.fail { border-color: rgba(248,81,73,0.5); background: rgba(248,81,73,0.08); }
    #detail-popover .dt-node.warn { border-color: rgba(210,153,34,0.5); background: rgba(210,153,34,0.08); }
    #detail-popover .dt-node.neutral { border-color: rgba(139,148,158,0.45); background: rgba(139,148,158,0.06); }
    #detail-popover .dt-node.blocker { animation: dtNodeIn 0.28s ease forwards, dtBlockPulse 1.8s ease-out infinite; animation-delay: calc(var(--i) * 70ms), 0.9s; }
    #detail-popover .dt-top { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
    #detail-popover .dt-step { width: 18px; height: 18px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.66rem; color: var(--text); border: 1px solid var(--border); background: rgba(0,0,0,0.25); }
    #detail-popover .dt-label { font-size: 0.75rem; font-weight: 600; flex: 1; min-width: 0; }
    #detail-popover .dt-state { font-size: 0.65rem; border-radius: 999px; padding: 1px 6px; border: 1px solid transparent; }
    #detail-popover .dt-node.pass .dt-state { color: var(--green); border-color: rgba(63,185,80,0.5); }
    #detail-popover .dt-node.fail .dt-state { color: var(--red); border-color: rgba(248,81,73,0.5); }
    #detail-popover .dt-node.warn .dt-state { color: var(--yellow); border-color: rgba(210,153,34,0.5); }
    #detail-popover .dt-node.neutral .dt-state { color: var(--muted); border-color: rgba(139,148,158,0.45); }
    #detail-popover .dt-desc { font-size: 0.74rem; line-height: 1.35; color: var(--text); word-break: break-word; }
    #detail-popover .dt-extra { margin-top: 4px; font-size: 0.68rem; color: var(--muted); word-break: break-word; }
    #detail-popover .dt-evidence { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px; }
    #detail-popover .dt-ev { display: inline-flex; align-items: center; gap: 3px; border: 1px solid var(--border); border-radius: 999px; padding: 1px 6px; font-size: 0.64rem; background: rgba(0,0,0,0.18); }
    #detail-popover .dt-ev.pass { color: var(--green); border-color: rgba(63,185,80,0.45); }
    #detail-popover .dt-ev.fail { color: var(--red); border-color: rgba(248,81,73,0.45); }
    #detail-popover .dt-ev.warn { color: var(--yellow); border-color: rgba(210,153,34,0.45); }
    #detail-popover .dt-ev.neutral { color: var(--muted); border-color: rgba(139,148,158,0.45); }
    #detail-popover .dt-arrow { align-self: center; flex: 0 0 auto; color: var(--muted); font-size: 0.95rem; }
    #detail-popover .path-compare { margin-top: 8px; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.12); }
    #detail-popover .path-title { font-size: 0.74rem; color: var(--muted); margin-bottom: 6px; }
    #detail-popover .path-track { margin-top: 6px; }
    #detail-popover .path-track-head { font-size: 0.7rem; color: var(--text); margin-bottom: 4px; display: flex; justify-content: space-between; gap: 8px; }
    #detail-popover .path-steps { display: flex; flex-wrap: wrap; gap: 6px; }
    #detail-popover .path-step { display: inline-flex; align-items: center; gap: 4px; font-size: 0.68rem; border-radius: 999px; padding: 2px 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.18); }
    #detail-popover .path-step.pass { color: var(--green); border-color: rgba(63,185,80,0.45); }
    #detail-popover .path-step.fail { color: var(--red); border-color: rgba(248,81,73,0.45); }
    #detail-popover .path-step.warn { color: var(--yellow); border-color: rgba(210,153,34,0.45); }
    #detail-popover .path-step.neutral { color: var(--muted); border-color: rgba(139,148,158,0.45); }
    #detail-popover .path-step.skip { color: var(--muted); border-color: rgba(139,148,158,0.35); opacity: 0.75; }
    #detail-popover .block-cause { border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.16); }
    #detail-popover .block-cause .bc-title { font-size: 0.72rem; color: var(--muted); margin-bottom: 4px; }
    #detail-popover .block-cause .bc-main { font-size: 0.78rem; color: var(--text); font-weight: 600; margin-bottom: 3px; }
    #detail-popover .block-cause .bc-desc { font-size: 0.7rem; color: var(--muted); word-break: break-word; }
    #detail-popover .impact-panel { border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.16); }
    #detail-popover .impact-title { font-size: 0.72rem; color: var(--muted); margin-bottom: 6px; }
    #detail-popover .impact-item { margin-bottom: 8px; }
    #detail-popover .impact-item:last-child { margin-bottom: 0; }
    #detail-popover .impact-meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.68rem; margin-bottom: 4px; }
    #detail-popover .impact-name { color: var(--text); }
    #detail-popover .impact-score { color: var(--muted); white-space: nowrap; }
    #detail-popover .impact-bar { position: relative; height: 8px; border-radius: 999px; background: rgba(139,148,158,0.22); overflow: hidden; }
    #detail-popover .impact-fill { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 999px; }
    #detail-popover .impact-fill.pass { background: linear-gradient(90deg, rgba(63,185,80,0.75), rgba(63,185,80,0.95)); }
    #detail-popover .impact-fill.fail { background: linear-gradient(90deg, rgba(248,81,73,0.75), rgba(248,81,73,0.95)); }
    #detail-popover .impact-fill.warn { background: linear-gradient(90deg, rgba(210,153,34,0.75), rgba(210,153,34,0.95)); }
    #detail-popover .impact-threshold { position: absolute; top: -2px; bottom: -2px; width: 2px; background: rgba(230,237,243,0.75); }
    #detail-popover .impact-rule { margin-top: 3px; font-size: 0.64rem; color: var(--muted); }
    #detail-popover details.fold { margin-top: 8px; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.12); overflow: hidden; }
    #detail-popover details.fold > summary { cursor: pointer; list-style: none; padding: 8px 10px; font-size: 0.76rem; color: var(--text); border-bottom: 1px solid transparent; }
    #detail-popover details.fold > summary::-webkit-details-marker { display: none; }
    #detail-popover details.fold > summary::after { content: '▾'; float: right; color: var(--muted); }
    #detail-popover details.fold[open] > summary { border-bottom-color: var(--border); }
    #detail-popover details.fold[open] > summary::after { content: '▴'; }
    #detail-popover .fold-body { padding: 8px 10px; }
    #detail-popover .compact-kv { display: grid; grid-template-columns: auto 1fr; gap: 4px 10px; font-size: 0.74rem; }
    #detail-popover .compact-kv .k { color: var(--muted); }
    #detail-popover .compact-kv .v { color: var(--text); word-break: break-word; }
    @keyframes dtNodeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes dtBlockPulse {
      0% { box-shadow: 0 0 0 0 rgba(248,81,73,0.38); }
      70% { box-shadow: 0 0 0 7px rgba(248,81,73,0.0); }
      100% { box-shadow: 0 0 0 0 rgba(248,81,73,0.0); }
    }
    .filters { margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .filters label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .filters input { accent-color: var(--green); }
    .table-toolbar { margin: 2px 0 8px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; color: var(--muted); font-size: 0.76rem; }
    .order-focus { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); border-radius: 999px; padding: 3px 8px; background: rgba(0,0,0,0.18); color: var(--muted); font-size: 0.72rem; }
    .order-focus.hidden { display: none; }
    .order-focus.positive { border-color: rgba(63,185,80,0.45); color: var(--green); }
    .order-focus.negative { border-color: rgba(248,81,73,0.45); color: var(--red); }
    .order-focus.neutral { border-color: rgba(210,153,34,0.45); color: var(--yellow); }
    .order-focus button { border: 1px solid var(--border); border-radius: 999px; background: rgba(0,0,0,0.2); color: var(--text); font-size: 0.68rem; padding: 2px 8px; cursor: pointer; }
    .order-focus button:hover { border-color: rgba(88,166,255,0.6); color: #58a6ff; }
    .pager { display: flex; align-items: center; gap: 6px; }
    .pager button { border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: var(--text); border-radius: 6px; padding: 4px 8px; font-size: 0.72rem; cursor: pointer; }
    .pager button:disabled { opacity: 0.45; cursor: not-allowed; }
    .pager .page-indicator { min-width: 70px; text-align: center; color: var(--text); font-size: 0.72rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; position: sticky; top: 0; background: var(--bg); }
    tr:hover { background: var(--card); }
    tr.highlight { background: rgba(63,185,80,0.15); }
    tr.order-focus-row { box-shadow: inset 0 0 0 999px rgba(88,166,255,0.09); }
    .ts { white-space: nowrap; color: var(--muted); cursor: pointer; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
    .badge.yes { background: rgba(63,185,80,0.2); color: var(--green); }
    .badge.no { background: rgba(248,81,73,0.2); color: var(--red); }
    .badge.dry { background: rgba(210,153,34,0.2); color: var(--yellow); }
    .reason { max-width: 280px; word-break: break-word; }
    .detail { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .order-focus-btn { margin-top: 4px; border: 1px solid var(--border); border-radius: 999px; background: rgba(0,0,0,0.2); color: #58a6ff; font-size: 0.68rem; padding: 2px 8px; cursor: pointer; }
    .order-focus-btn:hover { border-color: rgba(88,166,255,0.6); color: var(--text); }
    .order-focus-btn.compact { margin-top: 0; padding: 3px 8px; }
    .error-row { background: rgba(248,81,73,0.08); }
    .empty { text-align: center; padding: 24px; color: var(--muted); }
    .load-error { color: var(--red); padding: 16px; }
    .load-error pre { font-size: 0.75rem; margin-top: 8px; }
    .install-pwa { position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 260; border: 1px solid var(--border); border-radius: 12px; background: rgba(26,35,50,0.97); box-shadow: 0 8px 24px rgba(0,0,0,0.45); padding: 10px 12px; display: flex; gap: 10px; align-items: center; }
    .install-pwa.hidden { display: none; }
    .install-pwa .ipwa-main { flex: 1; min-width: 0; }
    .install-pwa .ipwa-title { font-size: 0.78rem; color: var(--text); font-weight: 600; margin-bottom: 2px; }
    .install-pwa .ipwa-desc { font-size: 0.72rem; color: var(--muted); line-height: 1.35; }
    .install-pwa .ipwa-actions { display: flex; gap: 8px; align-items: center; }
    .install-pwa button { border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: var(--text); border-radius: 8px; padding: 7px 10px; font-size: 0.74rem; cursor: pointer; }
    .install-pwa button.primary { background: rgba(63,185,80,0.18); border-color: rgba(63,185,80,0.5); color: var(--green); }
    .install-pwa button.ghost { color: var(--muted); }
    @media (max-width: 768px) {
      body { padding: 10px; }
      h1 { font-size: 1.02rem; margin-bottom: 4px; }
      .app-topbar { flex-direction: column; align-items: stretch; gap: 8px; }
      .top-actions { justify-content: flex-start; }
      .nav-btn { font-size: 0.72rem; padding: 6px 10px; }
      .assistant-nav { margin-bottom: 6px; }
      .ai-quick-btn { font-size: 0.66rem; padding: 4px 8px; }
      .dashboard-grid { grid-template-columns: 1fr; gap: 8px; }
      .panel-card { padding: 9px; border-radius: 10px; }
      .timeline-list { max-height: 280px; }
      .ai-input-row input { font-size: 16px; }
      #orders-table-wrap { display: block; overflow-x: auto; white-space: nowrap; }
      .chart-header { gap: 8px; margin-bottom: 6px; }
      .chart-header .meta { font-size: 0.75rem; line-height: 1.35; }
      .chart-header select { font-size: 16px; padding: 8px 10px; }
      #chart-wrap { height: min(56vh, 420px); min-height: 280px; border-radius: 10px; }
      #detail-popover { position: fixed; left: 8px !important; right: 8px !important; bottom: 8px !important; top: auto !important; width: auto !important; max-width: none; max-height: 68vh; border-radius: 12px; z-index: 300; }
      #detail-popover .popover-close { font-size: 1.25rem; padding: 8px; top: 4px; right: 4px; }
      #indicator-hover-tooltip { display: none !important; }
      #detail-popover .decision-tree-grid { grid-template-columns: 1fr; }
      #detail-popover .decision-tree { flex-direction: column; gap: 4px; overflow-x: hidden; }
      #detail-popover .dt-node { min-width: 0; width: 100%; }
      #detail-popover .dt-arrow { transform: rotate(90deg); align-self: flex-start; margin-left: 10px; }
      .install-pwa { left: 8px; right: 8px; bottom: 8px; padding: 9px 10px; }
      .install-pwa .ipwa-title { font-size: 0.76rem; }
      .install-pwa .ipwa-desc { font-size: 0.7rem; }
      .install-pwa button { font-size: 0.72rem; padding: 7px 9px; }
      .filters { gap: 6px; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
      .table-toolbar { margin-top: 0; font-size: 0.72rem; }
      .order-focus { width: 100%; justify-content: space-between; }
      .pager { width: 100%; justify-content: flex-end; }
      .pager button { padding: 5px 8px; }
      .filters label { font-size: 0.8rem; padding: 4px 8px; border: 1px solid var(--border); border-radius: 999px; background: var(--card); white-space: nowrap; }
      .filters input { width: 16px; height: 16px; }
      #table-wrap { display: block !important; }
      #table-wrap thead { display: none; }
      #table-wrap tbody,
      #table-wrap tr,
      #table-wrap td { display: block; width: 100%; }
      #table-wrap tr { margin-bottom: 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--card); padding: 6px 8px; }
      #table-wrap td { border-bottom: 0; padding: 6px 4px; display: flex; gap: 8px; align-items: flex-start; }
      #table-wrap td::before { content: attr(data-label); color: var(--muted); min-width: 44px; flex: 0 0 44px; }
      #table-wrap td.reason { max-width: none; }
      #table-wrap .ts { white-space: normal; }
      #table-wrap .detail { margin-top: 0; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-topbar">
      <div>
        <h1>AI 交易机器人集成看板</h1>
        <div class="app-subtitle" id="app-subtitle">围绕 AI 助理组织交易、风控与订单视图</div>
      </div>
    </div>

    <section id="view-dashboard" class="view-panel active">
      <div class="panel-card ai-chat-wrap">
        <div class="card-title-row">
          <h2>AI 交易助理（主页面）</h2>
          <span class="app-subtitle">从这里切换功能与发起提问</span>
        </div>
        <div class="assistant-nav">
          <button class="nav-btn active" data-view-target="dashboard" type="button">AI主页面</button>
          <button class="nav-btn" data-view-target="kline" type="button">打开K线</button>
          <button class="nav-btn" data-view-target="history" type="button">历史订单</button>
        </div>
        <div class="ai-quick" id="ai-quick">
          <button class="ai-quick-btn" type="button" data-ask="当前仓位是什么？">当前仓位</button>
          <button class="ai-quick-btn" type="button" data-ask="当前这单交易进展如何？">当前交易进展</button>
          <button class="ai-quick-btn" type="button" data-ask="当前风控状态怎么样？">风控状态</button>
          <button class="ai-quick-btn" type="button" data-view-target="kline">去看K线</button>
        </div>
        <div id="ai-chat-box" class="ai-chat-box"></div>
        <div class="ai-input-row">
          <input id="ai-chat-input" type="text" placeholder="例如：当前仓位是什么？策略状态如何？" />
          <button id="ai-chat-send" type="button">发送</button>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="panel-card">
          <div class="card-title-row">
            <h2>当前仓位</h2>
            <button id="go-kline-from-dashboard" class="card-action" type="button">查看K线</button>
          </div>
          <div id="current-position-list" class="position-grid">
            <div class="position-item"><div class="position-meta">加载中...</div></div>
          </div>
        </div>
        <div class="panel-card">
          <div class="card-title-row">
            <h2>运行策略</h2>
            <button id="go-history-from-dashboard" class="card-action" type="button">历史订单</button>
          </div>
          <div id="strategy-summary">
            <div class="strategy-grid">
              <div class="metric-tile"><div class="metric-label">状态</div><div class="metric-value">加载中...</div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel-card">
        <div class="card-title-row">
          <h2>当前交易运行时间线</h2>
          <span class="app-subtitle" id="current-trade-meta">聚焦当前单</span>
        </div>
        <div id="runtime-timeline" class="timeline-list"></div>
      </div>
    </section>

    <section id="view-kline" class="view-panel">
      <div class="card-title-row" style="margin-bottom:6px">
        <h2>K线决策视图</h2>
        <button class="nav-btn" data-view-target="dashboard" type="button">返回AI主页面</button>
      </div>
      <div class="chart-header">
        <select id="tf-select"><option value="1m" selected>分时(1分钟)</option><option value="5m">5分钟</option><option value="15m">15分钟</option><option value="1h">1小时</option><option value="4h">4小时</option><option value="1d">日线</option></select>
        <span class="meta" id="meta-symbol">· 电脑可悬停，手机可点击决策点/记录看详情</span>
      </div>
      <div id="chart-wrap"><p class="load-error">加载中…</p></div>
      <div id="indicator-hover-tooltip"></div>
      <div class="filters" id="filters" style="display:none">
        <label><input type="checkbox" id="filter-executed" /> 仅已下单</label>
        <label><input type="checkbox" id="filter-skipped" /> 仅未下单</label>
        <label><input type="checkbox" id="filter-signal" /> 仅有信号</label>
        <label><input type="checkbox" id="filter-errors" /> 含错误</label>
      </div>
      <div class="table-toolbar" id="table-toolbar" style="display:none">
        <div id="table-total">共 0 条</div>
        <div class="order-focus hidden" id="order-focus">
          <span id="order-focus-text"></span>
          <button id="order-focus-clear" type="button">清除高亮</button>
        </div>
        <div class="pager">
          <button id="page-prev" type="button">上一页</button>
          <span class="page-indicator" id="page-indicator">1 / 1</span>
          <button id="page-next" type="button">下一页</button>
        </div>
      </div>
      <table id="table-wrap" style="display:none">
        <thead>
          <tr>
            <th>时间</th>
            <th>信号</th>
            <th>计划</th>
            <th>新闻</th>
            <th>执行</th>
            <th>关联订单</th>
            <th>原因</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section id="view-history" class="view-panel">
      <div class="panel-card">
        <div class="card-title-row">
          <h2>历史订单详情</h2>
          <span>
            <span class="app-subtitle" id="history-total">共 0 条</span>
            <button class="nav-btn" data-view-target="dashboard" type="button">返回AI主页面</button>
          </span>
        </div>
        <div class="table-toolbar">
          <div class="history-summary" id="history-summary">点击任意订单可跳到 K 线高亮开平区间。</div>
          <div class="pager">
            <button id="history-prev" type="button">上一页</button>
            <span class="page-indicator" id="history-page-indicator">1 / 1</span>
            <button id="history-next" type="button">下一页</button>
          </div>
        </div>
        <table id="orders-table-wrap">
          <thead>
            <tr>
              <th>订单ID</th>
              <th>状态</th>
              <th>方向</th>
              <th>开仓时间</th>
              <th>平仓时间</th>
              <th>开仓价</th>
              <th>平仓价</th>
              <th>PnL</th>
              <th>时长</th>
              <th>来源</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="orders-tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="install-pwa" class="install-pwa hidden">
    <div class="ipwa-main">
      <div class="ipwa-title">安装为 App（更像原生应用）</div>
      <div class="ipwa-desc" id="install-pwa-desc">安装后可全屏打开，使用更顺手。</div>
    </div>
    <div class="ipwa-actions">
      <button id="install-pwa-btn" class="primary" type="button">安装</button>
      <button id="install-pwa-close" class="ghost" type="button">关闭</button>
    </div>
  </div>
  <script>
    const TF_CONFIG = [{"key":"1m","label":"分时(1分钟)","seconds":60},{"key":"5m","label":"5分钟","seconds":300},{"key":"15m","label":"15分钟","seconds":900},{"key":"1h","label":"1小时","seconds":3600},{"key":"4h","label":"4小时","seconds":14400},{"key":"1d","label":"日线","seconds":86400}];
    const TF_SECONDS = Object.fromEntries(TF_CONFIG.map(t => [t.key, t.seconds]));

    function setupPwaInstall() {
      const box = document.getElementById('install-pwa');
      const btn = document.getElementById('install-pwa-btn');
      const closeBtn = document.getElementById('install-pwa-close');
      const desc = document.getElementById('install-pwa-desc');
      if (!box || !btn || !closeBtn || !desc) return;

      let deferredPrompt = null;
      const ua = navigator.userAgent || '';
      const isIOS = /iphone|ipad|ipod/i.test(ua);
      const inStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (inStandalone) {
        box.classList.add('hidden');
        return;
      }

      function showHint(text, canInstall) {
        desc.textContent = text;
        btn.style.display = canInstall ? 'inline-block' : 'none';
        box.classList.remove('hidden');
      }
      function hideHint() {
        box.classList.add('hidden');
      }

      closeBtn.addEventListener('click', hideHint);

      window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        showHint('点击“安装”将当前页面加入桌面，像 App 一样全屏使用。', true);
      });

      btn.addEventListener('click', async function() {
        if (!deferredPrompt) return;
        try {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        } catch (_) {}
        deferredPrompt = null;
        hideHint();
      });

      if (isIOS) {
        showHint('iOS：请在 Safari 点“分享”→“添加到主屏幕”，即可作为 App 使用。', false);
      } else {
        // Android/desktop: wait for beforeinstallprompt first; keep hidden by default.
        hideHint();
      }
    }

    function registerPwaServiceWorker() {
      if (!('serviceWorker' in navigator)) return;
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js').catch(function() {});
      }, { once: true });
    }

    function buildMarkersForTf(records, tfSeconds) {
      return records.filter(r => r.ts && !r.stage).map(r => {
        const tsMs = new Date(r.ts).getTime();
        const time = Math.floor(tsMs / 1000 / tfSeconds) * tfSeconds;
        let color = '#8b949e', text = '';
        if (r.executor) {
          if (r.executor.executed) { color = '#3fb950'; text = r.signal?.plan?.side === 'long' ? '开多' : '开空'; }
          else if (r.executor.dryRun && (r.executor.wouldOpenPosition || r.executor.reason === 'dry_run_open')) { color = '#d29922'; text = 'Dry'; }
          else { color = '#f85149'; text = (r.executor.reason || 'skip').slice(0, 6); }
        }
        return { time, position: 'belowBar', color, shape: 'circle', text: text || '·', id: r.ts, size: 0.75 };
      });
    }

    function showLoadError(msg) {
      const html = '<p class="load-error">加载数据失败。请先运行 <code>node scripts/perp-report-data.js</code> 再通过 <code>node scripts/serve-report.js</code> 打开本页（不要直接双击 HTML 文件）。</p><pre>' + (msg || '') + '</pre>';
      const chart = document.getElementById('chart-wrap');
      if (chart) chart.innerHTML = html;
      const pos = document.getElementById('current-position-list');
      if (pos) pos.innerHTML = '<div class="position-item"><div class="position-meta">加载失败：' + (msg || 'unknown') + '</div></div>';
    }

    async function load() {
      const [decisions, ohlcvPayload, ordersPayload] = await Promise.all([
        fetch('decisions.json').then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); }),
        fetch('ohlcv.json').then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); }),
        fetch('orders.json')
          .then(r => (r.ok ? r.json() : { orders: [] }))
          .catch(() => ({ orders: [] })),
      ]);
      const RECORDS = Array.isArray(decisions) ? decisions : [];
      const OHLCV_BY_TF = (ohlcvPayload && ohlcvPayload.data) ? ohlcvPayload.data : (ohlcvPayload || {});
      const symbol = (ohlcvPayload && ohlcvPayload.symbol) ? ohlcvPayload.symbol : 'BTC/USDT:USDT';
      const MARKERS_BY_TF = {};
      (TF_CONFIG || []).forEach(({ key, seconds }) => { MARKERS_BY_TF[key] = buildMarkersForTf(RECORDS, seconds); });
      init(RECORDS, OHLCV_BY_TF, MARKERS_BY_TF, symbol, ordersPayload);
    }

    function init(RECORDS, OHLCV_BY_TF, MARKERS_BY_TF, symbol, ordersPayload) {
      const isTouchDevice = window.matchMedia('(hover: none), (pointer: coarse)').matches;
      const RECORDS_WITH_TS = RECORDS
        .filter(r => r && r.ts && !r.stage)
        .map(r => ({ r, tsSec: Math.floor(new Date(r.ts).getTime() / 1000) }))
        .filter(x => Number.isFinite(x.tsSec));
      const ORDERS = Array.isArray(ordersPayload?.orders)
        ? ordersPayload.orders
        : (Array.isArray(ordersPayload) ? ordersPayload : []);
      const ORDER_BY_CYCLE = new Map();
      const ORDER_BY_TRADE = new Map();
      for (const o of ORDERS) {
        if (!o) continue;
        if (o.tradeId != null) {
          const tradeKey = String(o.tradeId);
          if (!ORDER_BY_TRADE.has(tradeKey)) ORDER_BY_TRADE.set(tradeKey, o);
        }
        if (!o || o.cycleId == null) continue;
        const key = String(o.cycleId);
        if (!ORDER_BY_CYCLE.has(key)) ORDER_BY_CYCLE.set(key, o);
      }

      function findOrderForRecord(r) {
        if (!r || r.cycleId == null) return null;
        return ORDER_BY_CYCLE.get(String(r.cycleId)) || null;
      }

      function findOrderByTradeId(tradeId) {
        if (tradeId == null) return null;
        return ORDER_BY_TRADE.get(String(tradeId)) || null;
      }

      function fmtTsShort(isoLike) {
        if (!isoLike) return '-';
        const d = new Date(String(isoLike));
        if (!Number.isFinite(d.getTime())) return String(isoLike).slice(0, 16).replace('T', ' ');
        return d.toLocaleString('zh-CN', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      }

      function parseToSec(v) {
        if (v == null) return null;
        const ms = Date.parse(String(v));
        return Number.isFinite(ms) ? Math.floor(ms / 1000) : null;
      }

      function fmtPrice(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n.toFixed(2) : '-';
      }

      function fmtDurationMin(minLike) {
        const m = Number(minLike);
        if (!Number.isFinite(m) || m < 0) return '-';
        if (m < 60) return m.toFixed(0) + ' 分钟';
        const h = Math.floor(m / 60);
        const r = Math.floor(m % 60);
        return h + ' 小时 ' + r + ' 分';
      }

      function minutesFromTo(startTs, endTs) {
        const a = parseToSec(startTs);
        const b = parseToSec(endTs);
        if (!Number.isFinite(a) || !Number.isFinite(b) || b < a) return null;
        return (b - a) / 60;
      }

      const SORTED_RECORDS = RECORDS
        .filter(r => r && r.ts && !r.stage)
        .slice()
        .sort((a, b) => (Date.parse(b.ts) || 0) - (Date.parse(a.ts) || 0));
      const SORTED_ORDERS = ORDERS
        .slice()
        .sort((a, b) => (Date.parse(b?.openTs || b?.closeTs || '') || 0) - (Date.parse(a?.openTs || a?.closeTs || '') || 0));
      const OPEN_ORDERS = SORTED_ORDERS.filter(o => o && !o.closeTs);

      const viewMap = {
        dashboard: document.getElementById('view-dashboard'),
        kline: document.getElementById('view-kline'),
        history: document.getElementById('view-history'),
      };
      const navButtons = Array.from(document.querySelectorAll('.nav-btn[data-view-target]'));
      const appSubtitle = document.getElementById('app-subtitle');
      let onKlineVisible = null;

      function switchView(name) {
        const key = viewMap[name] ? name : 'dashboard';
        Object.entries(viewMap).forEach(([k, el]) => {
          if (!el) return;
          el.classList.toggle('active', k === key);
        });
        navButtons.forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('data-view-target') === key);
        });
        if (appSubtitle) {
          if (key === 'dashboard') appSubtitle.textContent = '围绕 AI 助理组织交易、风控与订单视图';
          else if (key === 'kline') appSubtitle.textContent = 'K 线与决策点联动视图';
          else appSubtitle.textContent = '历史订单明细（支持跳转回 K 线定位）';
        }
        if (key === 'kline' && typeof onKlineVisible === 'function') {
          window.requestAnimationFrame(onKlineVisible);
        }
      }
      navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          switchView(btn.getAttribute('data-view-target'));
        });
      });
      const goKlineBtn = document.getElementById('go-kline-from-dashboard');
      if (goKlineBtn) goKlineBtn.addEventListener('click', function() { switchView('kline'); });
      const goHistoryBtn = document.getElementById('go-history-from-dashboard');
      if (goHistoryBtn) goHistoryBtn.addEventListener('click', function() { switchView('history'); });
      const currentTradeMeta = document.getElementById('current-trade-meta');

      function getCurrentTradeOrder() {
        if (activeOrder) return activeOrder;
        if (OPEN_ORDERS.length) return OPEN_ORDERS
          .slice()
          .sort((a, b) => (Date.parse(b?.openTs || '') || 0) - (Date.parse(a?.openTs || '') || 0))[0];
        return SORTED_ORDERS[0] || null;
      }

      function renderCurrentPositions() {
        const wrap = document.getElementById('current-position-list');
        if (!wrap) return;
        if (!OPEN_ORDERS.length) {
          wrap.innerHTML = '<div class="position-item"><div class="position-top"><div class="position-title">当前无持仓</div><span class="badge dry">空仓</span></div><div class="position-meta">机器人仍在持续扫描市场信号。</div></div>';
          return;
        }
        wrap.innerHTML = OPEN_ORDERS.map(function(o) {
          const sideCls = o.side === 'short' ? 'short' : 'long';
          const sideText = o.side === 'short' ? '做空' : '做多';
          const openMin = minutesFromTo(o.openTs, new Date().toISOString());
          return '<div class="position-item ' + sideCls + '">' +
            '<div class="position-top"><div class="position-title">' + sideText + ' ' + escapeHtml(o.symbol || '-') + '</div><span class="badge ' + (sideCls === 'long' ? 'yes' : 'no') + '">' + sideText + '</span></div>' +
            '<div class="position-kv">' +
              '<div class="k">开仓时间</div><div class="v">' + escapeHtml(fmtTsShort(o.openTs)) + '</div>' +
              '<div class="k">开仓价格</div><div class="v">' + escapeHtml(fmtPrice(o.openPrice)) + '</div>' +
              '<div class="k">持仓时长</div><div class="v">' + escapeHtml(fmtDurationMin(openMin)) + '</div>' +
              '<div class="k">级别</div><div class="v">' + escapeHtml(o.level || '-') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
      }

      function detectStrategyLabel() {
        const latestWithPlan = SORTED_RECORDS.find(r => r?.signal?.plan?.reason || r?.signal?.algorithm?.note);
        if (!latestWithPlan) return '未知策略';
        const reason = String(latestWithPlan?.signal?.plan?.reason || '');
        if (/v5/i.test(reason)) return 'v5 趋势突破策略';
        if (/retest/i.test(reason)) return '回踩确认策略';
        if (/reentry/i.test(reason)) return '趋势再入策略';
        if (latestWithPlan?.signal?.algorithm?.note) return String(latestWithPlan.signal.algorithm.note);
        return '策略运行中';
      }

      function renderStrategySummary() {
        const box = document.getElementById('strategy-summary');
        if (!box) return;
        const total = SORTED_RECORDS.length;
        const signalCnt = SORTED_RECORDS.filter(r => r?.signal?.hasAlert).length;
        const executedCnt = SORTED_RECORDS.filter(r => r?.executor?.executed).length;
        const blockedCnt = SORTED_RECORDS.filter(r => r?.decision?.blockedByNews).length;
        const dryCnt = SORTED_RECORDS.filter(r => r?.executor?.dryRun && (r?.executor?.wouldOpenPosition || r?.executor?.reason === 'dry_run_open')).length;
        const latest = SORTED_RECORDS[0] || null;
        const runSince = SORTED_RECORDS[total - 1]?.ts || latest?.ts || null;
        const latestSide = latest?.signal?.plan?.side === 'short' ? '做空' : (latest?.signal?.plan?.side === 'long' ? '做多' : '无信号');
        const latestLevel = latest?.signal?.plan?.level || '-';
        const currentOrder = getCurrentTradeOrder();
        const currentTradeId = currentOrder?.tradeId != null ? String(currentOrder.tradeId) : '-';
        const currentState = currentOrder ? (currentOrder.closeTs ? '已平仓' : '持仓中') : '无当前单';
        const currentRuntime = currentOrder ? fmtDurationMin(currentOrder.durationMin != null ? currentOrder.durationMin : minutesFromTo(currentOrder.openTs, new Date().toISOString())) : '-';
        box.innerHTML = '<div class="strategy-grid">' +
          '<div class="metric-tile"><div class="metric-label">运行策略</div><div class="metric-value">' + escapeHtml(detectStrategyLabel()) + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">当前单ID</div><div class="metric-value">' + escapeHtml(currentTradeId) + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">当前单状态</div><div class="metric-value">' + escapeHtml(currentState) + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">当前单运行时长</div><div class="metric-value">' + escapeHtml(currentRuntime) + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">总轮次</div><div class="metric-value">' + total + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">信号触发</div><div class="metric-value">' + signalCnt + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">真实执行</div><div class="metric-value">' + executedCnt + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">新闻拦截</div><div class="metric-value">' + blockedCnt + '</div></div>' +
          '<div class="metric-tile"><div class="metric-label">Dry-run</div><div class="metric-value">' + dryCnt + '</div></div>' +
        '</div>' +
        '<div class="strategy-note">运行起点：' + escapeHtml(fmtTsShort(runSince)) + ' · 最新信号：' + escapeHtml(latestSide + ' / ' + latestLevel) + '</div>';
      }

      function buildCurrentTradeEvents(order, limit) {
        const maxN = Number.isFinite(Number(limit)) ? Number(limit) : 80;
        if (!order) return [];
        const start = parseToSec(order.openTs);
        const end = parseToSec(order.closeTs);
        const sideText = order.side === 'short' ? '做空' : (order.side === 'long' ? '做多' : '-');
        const events = [];

        events.push({
          ts: order.openTs,
          tag: 'order',
          title: '当前单开仓',
          sub: sideText + ' · 价格 ' + fmtPrice(order.openPrice) + ' · tradeId=' + (order.tradeId || '-'),
        });
        if (order.closeTs) {
          const pnl = Number(order.pnlEstUSDT);
          const pnlTxt = Number.isFinite(pnl) ? ((pnl >= 0 ? '+' : '') + pnl.toFixed(2) + 'U') : '-';
          events.push({
            ts: order.closeTs,
            tag: 'order',
            title: '当前单平仓',
            sub: '价格 ' + fmtPrice(order.closePrice) + ' · PnL ' + pnlTxt,
          });
        } else {
          events.push({
            ts: new Date().toISOString(),
            tag: 'info',
            title: '当前单仍在运行',
            sub: '已运行 ' + fmtDurationMin(minutesFromTo(order.openTs, new Date().toISOString())),
          });
        }

        const scopedRecords = SORTED_RECORDS.filter(function(r) {
          const t = parseToSec(r?.ts);
          if (!Number.isFinite(t) || !Number.isFinite(start)) return false;
          if (Number.isFinite(end) && t > end) return false;
          return t >= start;
        });

        scopedRecords.forEach(function(r) {
          const reason = String(r?.executor?.reason || '');
          const side = r?.signal?.plan?.side === 'short' ? '做空' : (r?.signal?.plan?.side === 'long' ? '做多' : '');
          if (r?.executor?.executed && r?.cycleId != null && order?.cycleId != null && String(r.cycleId) === String(order.cycleId)) {
            events.push({
              ts: r.ts,
              tag: 'order',
              title: '开仓执行确认',
              sub: (r?.executor?.reason || 'opened') + ' · cycleId=' + (r?.cycleId || '-'),
            });
            return;
          }
          if (/position_open|idempotent/i.test(reason)) {
            events.push({
              ts: r.ts,
              tag: 'info',
              title: '持仓检查',
              sub: '已有持仓，继续按当前单运行',
            });
            return;
          }
          if (r?.decision?.blockedByNews) {
            const riskReason = Array.isArray(r?.decision?.newsReason) && r.decision.newsReason.length
              ? r.decision.newsReason.join('; ')
              : '命中新闻风控';
            events.push({
              ts: r.ts,
              tag: 'risk',
              title: '新闻门控检查',
              sub: riskReason,
            });
            return;
          }
          if (r?.signal?.hasAlert) {
            events.push({
              ts: r.ts,
              tag: 'signal',
              title: '信号巡检：' + side + '（' + (r?.signal?.plan?.level || '-') + '）',
              sub: r?.signal?.plan?.reason || (r?.signal?.note || '-'),
            });
            return;
          }
          events.push({
            ts: r.ts,
            tag: 'info',
            title: '运行心跳',
            sub: r?.executor?.reason || (r?.signal?.note || '无新信号'),
          });
        });

        const seen = new Set();
        return events
          .filter(e => e.ts)
          .sort((a, b) => (Date.parse(b.ts) || 0) - (Date.parse(a.ts) || 0))
          .filter(function(e) {
            const k = (e.ts || '') + '|' + (e.title || '');
            if (seen.has(k)) return false;
            seen.add(k);
            return true;
          })
          .slice(0, maxN);
      }

      function renderRuntimeTimeline() {
        const wrap = document.getElementById('runtime-timeline');
        if (!wrap) return;
        const currentOrder = getCurrentTradeOrder();
        if (currentTradeMeta) {
          if (currentOrder) {
            const runMin = currentOrder.durationMin != null
              ? currentOrder.durationMin
              : minutesFromTo(currentOrder.openTs, new Date().toISOString());
            currentTradeMeta.textContent = 'tradeId=' + (currentOrder.tradeId || '-') + ' · ' + (currentOrder.side === 'short' ? '做空' : '做多') + ' · 运行 ' + fmtDurationMin(runMin);
          } else {
            currentTradeMeta.textContent = '当前无可聚焦交易';
          }
        }
        const events = buildCurrentTradeEvents(currentOrder, 80);
        if (!events.length) {
          wrap.innerHTML = '<div class="timeline-item"><div class="timeline-main">暂无当前单运行事件</div></div>';
          return;
        }
        wrap.innerHTML = events.map(function(e) {
          return '<div class="timeline-item">' +
            '<div class="timeline-head"><span class="timeline-tag ' + escapeHtml(e.tag || 'info') + '">' + escapeHtml((e.tag || 'info').toUpperCase()) + '</span><span class="timeline-ts">' + escapeHtml(fmtTsShort(e.ts)) + '</span></div>' +
            '<div class="timeline-main">' + escapeHtml(e.title || '-') + '</div>' +
            '<div class="timeline-sub">' + escapeHtml(e.sub || '-') + '</div>' +
          '</div>';
        }).join('');
      }

      function aiSnapshot() {
        const latest = SORTED_RECORDS[0] || null;
        const currentOrder = getCurrentTradeOrder();
        return {
          openCount: OPEN_ORDERS.length,
          latestSide: latest?.signal?.plan?.side === 'short' ? '做空' : (latest?.signal?.plan?.side === 'long' ? '做多' : '无信号'),
          latestTs: latest?.ts || null,
          blocked: SORTED_RECORDS.filter(r => r?.decision?.blockedByNews).length,
          executed: SORTED_RECORDS.filter(r => r?.executor?.executed).length,
          strategy: detectStrategyLabel(),
          currentTradeId: currentOrder?.tradeId || null,
          currentTradeState: currentOrder ? (currentOrder.closeTs ? '已平仓' : '持仓中') : '无当前单',
          currentTradeSide: currentOrder?.side === 'short' ? '做空' : (currentOrder?.side === 'long' ? '做多' : '-'),
          currentTradeOpen: currentOrder?.openTs || null,
          currentTradeDuration: currentOrder
            ? fmtDurationMin(currentOrder.durationMin != null ? currentOrder.durationMin : minutesFromTo(currentOrder.openTs, new Date().toISOString()))
            : '-',
        };
      }

      function renderAiChat() {
        const box = document.getElementById('ai-chat-box');
        const input = document.getElementById('ai-chat-input');
        const sendBtn = document.getElementById('ai-chat-send');
        if (!box || !input || !sendBtn) return;
        function pushMsg(role, text) {
          const div = document.createElement('div');
          div.className = 'ai-msg ' + role;
          div.textContent = text;
          box.appendChild(div);
          box.scrollTop = box.scrollHeight;
        }
        function answer(q) {
          const s = aiSnapshot();
          const ql = String(q || '').toLowerCase();
          if (!ql.trim()) return '可以问我：当前仓位、当前这单进展、策略状态、风险拦截、最近订单。';
          if (/仓位|持仓|position/.test(ql)) {
            if (!OPEN_ORDERS.length) return '当前无持仓，机器人处于空仓扫描状态。';
            return OPEN_ORDERS.map(function(o, i) {
              const side = o.side === 'short' ? '空' : '多';
              return (i + 1) + '. ' + side + ' ' + (o.symbol || '-') + '，开仓价 ' + fmtPrice(o.openPrice) + '，时间 ' + fmtTsShort(o.openTs);
            }).join('\n');
          }
          if (/这单|当前单|进展|timeline|时间线|过程/.test(ql)) {
            if (!s.currentTradeId) return '当前没有可跟踪的交易单。';
            return '当前单：' + s.currentTradeId + '\n方向：' + s.currentTradeSide + '\n状态：' + s.currentTradeState + '\n开仓时间：' + fmtTsShort(s.currentTradeOpen) + '\n运行时长：' + s.currentTradeDuration + '\n你可以切到「K线图」查看这单对应区间。';
          }
          if (/策略|signal|信号/.test(ql)) {
            return '当前策略：' + s.strategy + '\n当前单状态：' + s.currentTradeState + '\n最新信号：' + s.latestSide + ' @ ' + fmtTsShort(s.latestTs) + '\n累计执行：' + s.executed + ' 次';
          }
          if (/风险|新闻|风控/.test(ql)) {
            return '截至当前，新闻/风控拦截共 ' + s.blocked + ' 次。建议重点查看「当前交易运行时间线」里的 RISK 标签事件。';
          }
          if (/历史|订单|最近/.test(ql)) {
            const top = SORTED_ORDERS.slice(0, 3);
            if (!top.length) return '当前没有可用历史订单。';
            return top.map(function(o, idx) {
              const pnl = Number(o.pnlEstUSDT);
              const pnlTxt = Number.isFinite(pnl) ? ((pnl >= 0 ? '+' : '') + pnl.toFixed(2) + 'U') : '持仓中';
              return (idx + 1) + '. ' + (o.tradeId || '-') + ' · ' + (o.side === 'short' ? '空' : '多') + ' · ' + fmtTsShort(o.openTs) + ' · ' + pnlTxt;
            }).join('\n');
          }
          return '我能回答：\n- 当前仓位\n- 当前这单进展\n- 运行策略\n- 风控与新闻拦截\n- 最近订单\n也可以输入“帮我总结今天表现”。';
        }
        function send() {
          const text = input.value.trim();
          if (!text) return;
          pushMsg('user', text);
          input.value = '';
          setTimeout(function() {
            pushMsg('bot', answer(text));
          }, 120);
        }
        sendBtn.addEventListener('click', send);
        input.addEventListener('keydown', function(ev) {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            send();
          }
        });
        const quickBtns = Array.from(document.querySelectorAll('#ai-quick .ai-quick-btn'));
        quickBtns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            const viewTarget = btn.getAttribute('data-view-target');
            if (viewTarget) {
              switchView(viewTarget);
              return;
            }
            const ask = btn.getAttribute('data-ask') || '';
            if (!ask) return;
            pushMsg('user', ask);
            setTimeout(function() {
              pushMsg('bot', answer(ask));
            }, 120);
          });
        });
        pushMsg('bot', '交易助理已就绪。你可以问：当前仓位、当前这单进展、策略状态、风险拦截、最近订单。');
      }

      function renderDashboard() {
        renderCurrentPositions();
        renderStrategySummary();
        renderRuntimeTimeline();
        renderAiChat();
      }

      function orderRelationHtml(order) {
        if (!order) return '-';
        const sideCn = order.side === 'long' ? '多' : order.side === 'short' ? '空' : '-';
        const open = fmtTsShort(order.openTs);
        const close = order.closeTs ? fmtTsShort(order.closeTs) : null;
        const pnl = Number(order.pnlEstUSDT);
        const pnlTxt = Number.isFinite(pnl) ? ((pnl >= 0 ? '+' : '') + pnl.toFixed(2) + 'U') : 'NA';
        const syn = order.isSynthetic ? '<span class="detail">（模拟）</span>' : '';
        const tradeId = order.tradeId != null ? String(order.tradeId) : '';
        const actionBtn = tradeId
          ? '<button class="order-focus-btn compact" type="button" data-trade-id="' + escapeHtml(tradeId) + '">高亮区间</button>'
          : '';
        if (close) {
          return '<span class="badge ' + (Number.isFinite(pnl) ? (pnl >= 0 ? 'yes' : 'no') : 'dry') + '">' + sideCn + ' 开→平</span><div class="detail">' + open + ' → ' + close + ' · ' + pnlTxt + syn + '</div>' + actionBtn;
        }
        return '<span class="badge dry">' + sideCn + ' 持仓中</span><div class="detail">开仓: ' + open + syn + '</div>' + actionBtn;
      }
      document.getElementById('meta-symbol').textContent = symbol + (isTouchDevice
        ? ' · 手机端：点记录/高亮区间看开平关系，双指缩放 K 线'
        : ' · 鼠标悬停决策点看详情；点“高亮区间”可定位开平段');
      document.getElementById('chart-wrap').innerHTML = '<div id="detail-popover"></div>';
      document.getElementById('filters').style.display = 'flex';
      document.getElementById('table-toolbar').style.display = 'flex';
      document.getElementById('table-wrap').style.display = 'table';
      const chartEl = document.createElement('div');
      chartEl.style.height = '100%';
      document.getElementById('chart-wrap').insertBefore(chartEl, document.getElementById('detail-popover'));

      let currentTf = '1m';
      let currentOhlcv = OHLCV_BY_TF[currentTf] || [];
      const chartWrap = document.getElementById('chart-wrap');
      const popover = document.getElementById('detail-popover');
      const orderFocusBox = document.getElementById('order-focus');
      const orderFocusText = document.getElementById('order-focus-text');
      const orderFocusClear = document.getElementById('order-focus-clear');
      const historyTotal = document.getElementById('history-total');
      const historySummary = document.getElementById('history-summary');
      const historyPageIndicator = document.getElementById('history-page-indicator');
      const historyPrev = document.getElementById('history-prev');
      const historyNext = document.getElementById('history-next');
      const historyTbody = document.getElementById('orders-tbody');

      const chart = LightweightCharts.createChart(chartEl, {
        layout: { background: { type: 'solid', color: '#0f1419' }, textColor: '#8b949e' },
        grid: { vertLines: { color: '#1a2332' }, horzLines: { color: '#1a2332' } },
        rightPriceScale: { borderColor: '#2d3a4f', scaleMargins: { top: 0.1, bottom: 0.2 } },
        timeScale: { borderColor: '#2d3a4f', timeVisible: true, secondsVisible: false },
      });
      const candleSeries = chart.addCandlestickSeries({ upColor: '#3fb950', downColor: '#f85149', borderVisible: false });
      const orderBandSeries = chart.addHistogramSeries({
        priceScaleId: '',
        priceFormat: { type: 'volume' },
        color: 'rgba(88,166,255,0.25)',
        priceLineVisible: false,
        lastValueVisible: false,
      });
      try {
        orderBandSeries.priceScale().applyOptions({ visible: false, scaleMargins: { top: 0.88, bottom: 0 } });
      } catch (_) {}
      let activeOrderTradeId = null;
      let activeOrder = null;

      function orderPnlColor(order, alpha) {
        const a = Number.isFinite(Number(alpha)) ? Number(alpha) : 0.42;
        const pnl = Number(order?.pnlEstUSDT);
        if (Number.isFinite(pnl)) {
          if (pnl > 0) return 'rgba(63,185,80,' + a + ')';
          if (pnl < 0) return 'rgba(248,81,73,' + a + ')';
        }
        return 'rgba(210,153,34,' + a + ')';
      }

      function findBarIndexAtOrAfter(sec) {
        if (!Number.isFinite(sec) || !currentOhlcv.length) return -1;
        for (let i = 0; i < currentOhlcv.length; i++) if (currentOhlcv[i].time >= sec) return i;
        return -1;
      }

      function findBarIndexAtOrBefore(sec) {
        if (!Number.isFinite(sec) || !currentOhlcv.length) return -1;
        for (let i = currentOhlcv.length - 1; i >= 0; i--) if (currentOhlcv[i].time <= sec) return i;
        return -1;
      }

      function buildOrderBandData(order) {
        if (!order || !currentOhlcv.length) return [];
        const tfSec = TF_SECONDS[currentTf] || 60;
        const rawOpen = parseToSec(order.openTs);
        if (!Number.isFinite(rawOpen)) return [];
        const rawClose = parseToSec(order.closeTs);
        let startSec = Math.floor(rawOpen / tfSec) * tfSec;
        let endSec = Number.isFinite(rawClose) ? (Math.floor(rawClose / tfSec) * tfSec) : currentOhlcv[currentOhlcv.length - 1].time;
        if (endSec < startSec) { const tmp = startSec; startSec = endSec; endSec = tmp; }
        const color = orderPnlColor(order, 0.42);
        const bars = currentOhlcv.filter(c => c.time >= startSec && c.time <= endSec);
        if (bars.length) return bars.map(c => ({ time: c.time, value: 1, color }));
        const fallbackIdx = findBarIndexAtOrBefore(startSec);
        if (fallbackIdx < 0) return [];
        return [{ time: currentOhlcv[fallbackIdx].time, value: 1, color }];
      }

      function buildOrderMarkers(order) {
        if (!order || !currentOhlcv.length) return [];
        const tfSec = TF_SECONDS[currentTf] || 60;
        const openSec = parseToSec(order.openTs);
        if (!Number.isFinite(openSec)) return [];
        const closeSec = parseToSec(order.closeTs);
        const side = order.side === 'short' ? 'short' : 'long';
        const openSnap = Math.floor(openSec / tfSec) * tfSec;
        const openIdx = findBarIndexAtOrBefore(openSnap);
        const markers = [];
        if (openIdx >= 0) {
          markers.push({
            time: currentOhlcv[openIdx].time,
            shape: side === 'short' ? 'arrowDown' : 'arrowUp',
            position: side === 'short' ? 'aboveBar' : 'belowBar',
            color: '#58a6ff',
            text: side === 'short' ? '开空' : '开多',
            size: isTouchDevice ? 1.25 : 0.9,
          });
        }
        if (Number.isFinite(closeSec)) {
          const closeSnap = Math.floor(closeSec / tfSec) * tfSec;
          const closeIdx = findBarIndexAtOrAfter(closeSnap);
          if (closeIdx >= 0) {
            const pnl = Number(order.pnlEstUSDT);
            const closeText = Number.isFinite(pnl) ? ('平 ' + (pnl >= 0 ? '+' : '') + pnl.toFixed(1) + 'U') : '平仓';
            markers.push({
              time: currentOhlcv[closeIdx].time,
              shape: side === 'short' ? 'arrowUp' : 'arrowDown',
              position: side === 'short' ? 'belowBar' : 'aboveBar',
              color: orderPnlColor(order, 1),
              text: closeText,
              size: isTouchDevice ? 1.25 : 0.95,
            });
          }
        }
        return markers;
      }

      function applyOrderFocusBadge() {
        if (!orderFocusBox || !orderFocusText) return;
        if (!activeOrder) {
          orderFocusBox.className = 'order-focus hidden';
          orderFocusText.textContent = '';
          return;
        }
        const sideCn = activeOrder.side === 'short' ? '空' : '多';
        const pnl = Number(activeOrder.pnlEstUSDT);
        const pnlTxt = Number.isFinite(pnl) ? ((pnl >= 0 ? '+' : '') + pnl.toFixed(2) + 'U') : '持仓中';
        const tradeLabel = activeOrder.tradeId != null ? String(activeOrder.tradeId) : '-';
        orderFocusBox.className = 'order-focus ' + (Number.isFinite(pnl) ? (pnl >= 0 ? 'positive' : 'negative') : 'neutral');
        orderFocusText.textContent = '高亮订单 ' + tradeLabel + ' · ' + sideCn + ' · ' + fmtTsShort(activeOrder.openTs) + (activeOrder.closeTs ? (' → ' + fmtTsShort(activeOrder.closeTs)) : ' → 持仓中') + ' · ' + pnlTxt;
      }

      function syncOrderHighlightRows() {
        const rows = document.querySelectorAll('#tbody tr[data-trade-id], #orders-tbody tr[data-trade-id]');
        rows.forEach(function(tr) {
          const isActive = activeOrderTradeId && tr.getAttribute('data-trade-id') === activeOrderTradeId;
          tr.classList.toggle('order-focus-row', Boolean(isActive));
        });
      }

      function applySeriesMarkers() {
        const base = (MARKERS_BY_TF[currentTf] || []).map(m => ({ ...m, time: m.time, size: isTouchDevice ? 1.2 : 0.75 }));
        const overlay = activeOrder ? buildOrderMarkers(activeOrder) : [];
        candleSeries.setMarkers(base.concat(overlay));
      }

      function applyOrderBand() {
        if (!activeOrder) {
          orderBandSeries.setData([]);
          return;
        }
        orderBandSeries.setData(buildOrderBandData(activeOrder));
      }

      function focusOrderRange(order) {
        if (!order || !currentOhlcv.length) return;
        const tfSec = TF_SECONDS[currentTf] || 60;
        const openSec = parseToSec(order.openTs);
        const closeSecRaw = parseToSec(order.closeTs);
        if (!Number.isFinite(openSec)) return;
        const startSec = Math.floor(openSec / tfSec) * tfSec;
        const endSec = Number.isFinite(closeSecRaw)
          ? Math.floor(closeSecRaw / tfSec) * tfSec
          : currentOhlcv[currentOhlcv.length - 1].time;
        const s = Math.min(startSec, endSec);
        const e = Math.max(startSec, endSec);
        const startIdx = findBarIndexAtOrAfter(s);
        const endIdx = findBarIndexAtOrAfter(e);
        if (startIdx >= 0 && endIdx >= 0) {
          chart.timeScale().setVisibleLogicalRange({
            from: Math.max(0, startIdx - 8),
            to: Math.min(currentOhlcv.length, endIdx + 10),
          });
        }
      }

      function setActiveOrder(order, opts) {
        const forceFocus = Boolean(opts && opts.focus);
        if (!order || order.tradeId == null) {
          activeOrderTradeId = null;
          activeOrder = null;
          applyOrderBand();
          applySeriesMarkers();
          applyOrderFocusBadge();
          syncOrderHighlightRows();
          renderRuntimeTimeline();
          renderStrategySummary();
          return;
        }
        activeOrderTradeId = String(order.tradeId);
        activeOrder = order;
        applyOrderBand();
        applySeriesMarkers();
        applyOrderFocusBadge();
        syncOrderHighlightRows();
        renderRuntimeTimeline();
        renderStrategySummary();
        if (forceFocus) focusOrderRange(order);
      }

      if (orderFocusClear) {
        orderFocusClear.addEventListener('click', function() {
          setActiveOrder(null);
        });
      }

      function jumpToOrder(order) {
        if (!order) return;
        setActiveOrder(order, { focus: true });
        switchView('kline');
        const cycleId = order.cycleId != null ? String(order.cycleId) : null;
        if (!cycleId) return;
        const rec = RECORDS.find(r => r && !r.stage && r.cycleId != null && String(r.cycleId) === cycleId);
        if (rec) showPopoverPinned(rec);
      }

      const HISTORY_PAGE_SIZE = isTouchDevice ? 10 : 16;
      let historyPage = 1;
      function renderHistoryOrders() {
        if (!historyTbody) return;
        const list = SORTED_ORDERS.slice();
        const total = list.length;
        const totalPages = Math.max(1, Math.ceil(total / HISTORY_PAGE_SIZE));
        if (historyPage > totalPages) historyPage = totalPages;
        if (historyPage < 1) historyPage = 1;
        if (historyTotal) historyTotal.textContent = '共 ' + total + ' 条';
        if (historyPageIndicator) historyPageIndicator.textContent = historyPage + ' / ' + totalPages;
        if (historyPrev) historyPrev.disabled = historyPage <= 1;
        if (historyNext) historyNext.disabled = historyPage >= totalPages;

        if (!total) {
          historyTbody.innerHTML = '<tr><td colspan="11" class="empty">暂无历史订单</td></tr>';
          if (historySummary) historySummary.textContent = '当前没有可展示的订单数据。';
          return;
        }
        const start = (historyPage - 1) * HISTORY_PAGE_SIZE;
        const pageList = list.slice(start, start + HISTORY_PAGE_SIZE);
        if (historySummary) {
          const closed = list.filter(o => o.closeTs).length;
          const open = list.filter(o => !o.closeTs).length;
          historySummary.textContent = '已平仓 ' + closed + ' 条，持仓中 ' + open + ' 条。点击“定位K线”可跳转到区间高亮。';
        }
        historyTbody.innerHTML = pageList.map(function(o) {
          const tradeId = o?.tradeId != null ? String(o.tradeId) : '-';
          const status = o?.closeTs ? '已平仓' : '持仓中';
          const side = o?.side === 'short' ? '做空' : (o?.side === 'long' ? '做多' : '-');
          const pnl = Number(o?.pnlEstUSDT);
          const pnlTxt = Number.isFinite(pnl) ? ((pnl >= 0 ? '+' : '') + pnl.toFixed(2) + 'U') : '-';
          const sourceTxt = o?.isSynthetic ? '模拟' : (o?.source || 'real');
          return '<tr data-trade-id="' + escapeHtml(tradeId) + '">' +
            '<td>' + escapeHtml(tradeId) + '</td>' +
            '<td><span class="badge ' + (o?.closeTs ? 'yes' : 'dry') + '">' + escapeHtml(status) + '</span></td>' +
            '<td>' + escapeHtml(side) + '</td>' +
            '<td>' + escapeHtml(fmtTsShort(o?.openTs)) + '</td>' +
            '<td>' + escapeHtml(fmtTsShort(o?.closeTs)) + '</td>' +
            '<td>' + escapeHtml(fmtPrice(o?.openPrice)) + '</td>' +
            '<td>' + escapeHtml(fmtPrice(o?.closePrice)) + '</td>' +
            '<td>' + escapeHtml(pnlTxt) + '</td>' +
            '<td>' + escapeHtml(fmtDurationMin(o?.durationMin)) + '</td>' +
            '<td>' + escapeHtml(sourceTxt) + '</td>' +
            '<td><button class="order-focus-btn compact" type="button" data-trade-id="' + escapeHtml(tradeId) + '">定位K线</button></td>' +
          '</tr>';
        }).join('');
        historyTbody.querySelectorAll('.order-focus-btn[data-trade-id]').forEach(function(btn) {
          btn.addEventListener('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            const order = findOrderByTradeId(btn.getAttribute('data-trade-id'));
            if (order) jumpToOrder(order);
          });
        });
        historyTbody.querySelectorAll('tr[data-trade-id]').forEach(function(tr) {
          tr.addEventListener('click', function() {
            const order = findOrderByTradeId(tr.getAttribute('data-trade-id'));
            if (order) jumpToOrder(order);
          });
        });
        syncOrderHighlightRows();
      }
      if (historyPrev) historyPrev.addEventListener('click', function() { if (historyPage > 1) { historyPage -= 1; renderHistoryOrders(); } });
      if (historyNext) historyNext.addEventListener('click', function() { historyPage += 1; renderHistoryOrders(); });

      function resizeChart() {
        const w = Math.floor(chartEl.clientWidth || chartWrap.clientWidth || 0);
        const h = Math.floor(chartEl.clientHeight || chartWrap.clientHeight || 0);
        if (w > 0 && h > 0) chart.applyOptions({ width: w, height: h });
      }
      if (typeof ResizeObserver !== 'undefined') {
        const ro = new ResizeObserver(resizeChart);
        ro.observe(chartEl);
      }
      window.addEventListener('resize', resizeChart, { passive: true });
      resizeChart();
      onKlineVisible = function() {
        resizeChart();
        applySeriesMarkers();
        applyOrderBand();
      };

      function setTf(tf) {
        currentTf = tf;
        currentOhlcv = OHLCV_BY_TF[tf] || [];
        candleSeries.setData(currentOhlcv);
        applySeriesMarkers();
        applyOrderBand();
        chart.timeScale().fitContent();
        if (typeof clearDecisionPriceLines === 'function') clearDecisionPriceLines();
      }
      document.getElementById('tf-select').addEventListener('change', e => setTf(e.target.value));
      setTf('1m');

      var decisionPriceLines = [];
      function clearDecisionPriceLines() { var list = (decisionPriceLines && Array.isArray(decisionPriceLines)) ? decisionPriceLines : []; decisionPriceLines = []; list.forEach(function(pl) { try { candleSeries.removePriceLine(pl); } catch (_) {} }); }
      function applyDecisionPriceLines(record) {
        clearDecisionPriceLines();
        if (!record || !record.signal) return;
        var alg = record.signal.algorithm;
        var calc = (alg && alg.meta && alg.meta.calc) ? alg.meta.calc : (alg && alg.calc) ? alg.calc : null;
        var level = (alg && alg.meta && alg.meta.level != null) ? alg.meta.level : (calc && calc['突破位'] != null) ? calc['突破位'] : null;
        if (level != null) {
          decisionPriceLines.push(candleSeries.createPriceLine({ price: level, color: '#d29922', lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: '突破位 ' + Number(level).toFixed(0) }));
        }
        var tol = (calc && calc['容差'] != null) ? calc['容差'] : null;
        if (level != null && tol != null) {
          decisionPriceLines.push(candleSeries.createPriceLine({ price: level + tol, color: 'rgba(139,148,158,0.7)', lineWidth: 1, lineStyle: 0, axisLabelVisible: true, title: '上界+' + Number(tol).toFixed(0) }));
          decisionPriceLines.push(candleSeries.createPriceLine({ price: level - tol, color: 'rgba(139,148,158,0.7)', lineWidth: 1, lineStyle: 0, axisLabelVisible: true, title: '下界-' + Number(tol).toFixed(0) }));
        }
        var emaKey = null;
        if (calc && typeof calc === 'object') { Object.keys(calc).forEach(function(k) { if (/1H_EMA\d+/.test(k) || (k.indexOf('EMA') >= 0 && typeof calc[k] === 'number')) emaKey = emaKey || k; }); }
        if (emaKey && calc[emaKey] != null) {
          decisionPriceLines.push(candleSeries.createPriceLine({ price: calc[emaKey], color: '#58a6ff', lineWidth: 2, lineStyle: 2, axisLabelVisible: true, title: emaKey + ' ' + Number(calc[emaKey]).toFixed(0) }));
        }
      }

      function escapeHtml(s) { const x = arguments[0]; if (x == null) return ''; return String(x).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
      var INDICATOR_EXPLAIN = {
        '4H_EMA快': { steps: ['取 4 小时图最近 20 根 K 线收盘价', 'EMA(n) = 收盘 × 2/(1+n) + 原EMA × (1 - 2/(1+n))', '逐根递推得当前 4H_EMA快'], formula: '新EMA = 收盘×2/21 + 原EMA×19/21', chartHint: '4H 图切换周期可查' },
        '4H_EMA慢': { steps: ['取 4 小时图最近 50 根 K 线收盘价', '同上 EMA 递推，n=50'], formula: '新EMA = 收盘×2/51 + 原EMA×49/51', chartHint: '4H 图切换周期可查' },
        '4H_ADX': { steps: ['由 4H 的 +DM、-DM、TR 算 +DI、-DI', 'DX = |+DI - -DI| / (+DI + -DI) × 100', 'ADX = DX 的 14 期平滑'], formula: 'ADX(14)，≥15 视为有趋势', chartHint: '4H 图查看' },
        '1H_ATR': { steps: ['每根 K 线：TR = max(高-低, |高-前收|, |低-前收|)', 'ATR = TR 的 14 期均线'], formula: 'ATR(14)；容差 = 系数 × ATR', chartHint: '图中灰线为突破位±容差' },
        '突破位': { steps: ['取 1 小时图前 15 根 K 线', '做多：突破位 = max(这 15 根的 最高价)', '做空：突破位 = min(这 15 根的 最低价)'], formula: 'Donchian(15)：前15根高/低的极值', chartHint: '图中黄线即本单突破位' },
        '容差': { steps: ['先算 1H_ATR(14)', '容差 = 系数 × 1H_ATR', '突破回踩系数≈0.25，趋势再入≈0.35'], formula: '容差 = 系数 × ATR', chartHint: '图中灰线为上/下界' },
        '收盘': { steps: ['当前 1 小时 K 线结束时的成交价'], formula: '即该 K 线收盘价', chartHint: 'K 线烛身顶或底' },
        '高': { steps: ['当前 1 小时 K 线内的最高价'], formula: '该根 K 线的 高', chartHint: '图中该 K 线上影/烛顶' },
        '低': { steps: ['当前 1 小时 K 线内的最低价'], formula: '该根 K 线的 低', chartHint: '图中该 K 线下影/烛底' },
        '方向': { steps: ['由 4H_EMA快、4H_EMA慢 比较', '快线 > 慢线 → long，否则 short'], formula: 'bias = 多空方向', chartHint: '决定做多/做空' }
      };
      function getIndicatorExplain(key) {
        if (INDICATOR_EXPLAIN[key]) return INDICATOR_EXPLAIN[key];
        if (key.indexOf('EMA') >= 0) { var m = key.match(/(\d+)/g); var period = (m && m.length) ? m[m.length - 1] : '20'; return { steps: ['取 1 小时图最近 ' + period + ' 根 K 线收盘价', 'EMA 递推：新 = 收×2/(1+n) + 原×(1-2/(1+n))'], formula: 'EMA(' + period + ')', chartHint: '图中蓝线即本单该 EMA' }; }
        return { steps: ['策略内部计算'], formula: '-', chartHint: '图中或已标出' };
      }
      function executorReasonToChinese(reason) {
        if (!reason) return '';
        var s = String(reason);
        if (/blocked_by_news/i.test(s)) return '新闻风控拦截';
        if (/no_plan/i.test(s)) return '无交易计划';
        if (/position_open|idempotent/i.test(s)) return '已有持仓或重复';
        if (/daily_cap/i.test(s)) return '触及日亏损上限';
        if (/min_interval/i.test(s)) return '距上次开仓间隔不足';
        if (/dry_run_open|wouldOpenPosition/i.test(s)) return 'Dry-run 会开仓';
        if (/opened|executed/i.test(s)) return '已下单';
        if (/auto_disabled/i.test(s)) return '自动禁用';
        return s;
      }
      function planReasonToChinese(reason) {
        if (!reason || typeof reason !== 'string') return reason || '';
        var s = reason.trim();
        var retestRe = new RegExp('v5\\s+retest:\\s*bias=(long|short)(?:;\\s*breakout@([^;]+))?(?:;\\s*breakout)?(?:;\\s*level=([\\d.]+))?(?:;\\s*tol=([\\d.]+))?', 'i');
        var retest = s.match(retestRe);
        if (retest) {
          var sideCn = retest[1].toLowerCase() === 'long' ? '做多' : '做空';
          var timeStr = '';
          if (retest[2]) { try { timeStr = new Date(retest[2].trim()).toLocaleString('zh-CN', { hour12: false, month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (_) {} }
          var levelStr = retest[3] ? (Number(retest[3]).toLocaleString('zh-CN') + ' 美元') : '';
          var tolStr = retest[4] ? ('容差 ' + Number(retest[4]).toFixed(0) + ' 美元') : '';
          if (levelStr && tolStr && timeStr) return '1 小时图在 ' + timeStr + ' 曾出现' + (retest[1].toLowerCase() === 'long' ? '向上' : '向下') + '突破。当前 K 线回踩至约 ' + levelStr + '（' + tolStr + '）后，' + (retest[1].toLowerCase() === 'long' ? '收盘重新站上该位' : '收盘重新跌破该位') + '，策略确认为' + sideCn + '信号。';
          if (levelStr && tolStr) return '1 小时图突破后，价格回踩至约 ' + levelStr + '（' + tolStr + '）并收盘确认，策略给出' + sideCn + '信号。';
          if (levelStr) return '1 小时图突破后回踩至约 ' + levelStr + ' 并确认，策略给出' + sideCn + '信号。';
          return '1 小时图突破后回踩确认，策略给出' + sideCn + '信号。';
        }
        var reentryRe = new RegExp('v5\\s+reentry:\\s*bias=(long|short);\\s*ema(\\d+)=([\\d.]+)(?:;\\s*tol=([\\d.]+))?', 'i');
        var reentry = s.match(reentryRe);
        if (reentry) {
          var sideCn2 = reentry[1].toLowerCase() === 'long' ? '做多' : '做空';
          var emaVal = Number(reentry[3]).toLocaleString('zh-CN');
          var tolStr2 = reentry[4] ? ('容差 ' + Number(reentry[4]).toFixed(0) + ' 美元内') : '';
          return '趋势内再次入场：价格回踩 1 小时 EMA' + reentry[2] + '（约 ' + emaVal + ' 美元）' + (tolStr2 ? '，在' + tolStr2 + '触及' : '') + '后收盘确认，策略给出' + sideCn2 + '信号。';
        }
        return s;
      }
      function renderDetailCard(r) {
        const ts = r.ts ? new Date(r.ts).toLocaleString('zh-CN', { hour12: false }) : '-';
        const p = r?.signal?.plan || null;
        const hasAlert = Boolean(r?.signal?.hasAlert);
        const planSide = p?.side || '';
        const planLevel = p?.level || '';
        const planReasonText = p?.reason ? planReasonToChinese(String(p.reason)) : '';
        const newsBlocked = r?.decision?.blockedByNews === true;
        const newsReasonText = Array.isArray(r?.decision?.newsReason) && r.decision.newsReason.length
          ? String(r.decision.newsReason.join('; '))
          : '';
        const e = r?.executor || null;
        const executed = Boolean(e?.executed);
        const dryRunOpen = Boolean(e?.dryRun && (e?.wouldOpenPosition || e?.reason === 'dry_run_open'));
        const skipped = Boolean(e?.skipped);
        const execReasonRaw = e?.reason ? String(e.reason) : '';
        const execReasonText = execReasonRaw ? executorReasonToChinese(execReasonRaw) : '';
        const order = findOrderForRecord(r);

        var alg = r.signal && r.signal.algorithm;
        var calc = (alg && alg.meta && alg.meta.calc) ? alg.meta.calc : (alg && alg.calc) ? alg.calc : null;
        if (!calc && (alg || p?.reason)) {
          calc = {};
          if (alg && alg.meta) {
            if (alg.meta.level != null) calc['突破位'] = Number(alg.meta.level);
            if (alg.meta.bias) calc['方向'] = alg.meta.bias;
            if (alg.meta.adx != null) calc['4H_ADX'] = Number(alg.meta.adx);
          }
          var reasonStr = p?.reason ? String(p.reason).trim() : '';
          var retestM = reasonStr.match(new RegExp('v5\\s+retest:\\s*bias=(long|short)(?:;\\s*breakout@([^;]+))?(?:;\\s*breakout)?(?:;\\s*level=([\\d.]+))?(?:;\\s*tol=([\\d.]+))?', 'i'));
          if (retestM) { if (retestM[3]) calc['突破位'] = Number(retestM[3]); if (retestM[4]) calc['容差'] = Number(retestM[4]); }
          var reentryM = reasonStr.match(new RegExp('v5\\s+reentry:\\s*bias=(long|short);\\s*ema(\\d+)=([\\d.]+)(?:;\\s*tol=([\\d.]+))?', 'i'));
          if (reentryM) { calc['1H_EMA' + reentryM[2]] = Number(reentryM[3]); if (reentryM[4]) calc['容差'] = Number(reentryM[4]); }
          if (Object.keys(calc).length === 0) calc = null;
        }

        function statusLabel(s) {
          if (s === 'pass') return '通过';
          if (s === 'fail') return '阻断';
          if (s === 'warn') return '观察';
          return '信息';
        }
        function nodeHtml(step, stage, idx, blockerIdx) {
          const status = stage?.status || 'neutral';
          const blockerCls = idx === blockerIdx ? ' blocker' : '';
          const extraBlock = stage?.extraHtml
            ? stage.extraHtml
            : (stage?.extra ? '<div class="dt-extra">' + escapeHtml(stage.extra) + '</div>' : '');
          return '<div class="dt-node ' + status + blockerCls + '" style="--i:' + (idx + 1) + ';">' +
            '<div class="dt-top"><span class="dt-step">' + step + '</span><span class="dt-label">' + escapeHtml(stage?.label || '-') + '</span><span class="dt-state">' + statusLabel(status) + '</span></div>' +
            '<div class="dt-desc">' + escapeHtml(stage?.desc || '-') + '</div>' +
            extraBlock +
          '</div>';
        }
        function flowStep(label, status, text) {
          return '<span class="path-step ' + status + '"><span>' + escapeHtml(label) + '</span><strong>' + escapeHtml(text) + '</strong></span>';
        }
        function toNum(v) {
          const n = Number(v);
          return Number.isFinite(n) ? n : null;
        }
        function sigEvidence() {
          const side = planSide === 'short' ? 'short' : (planSide === 'long' ? 'long' : null);
          const f = toNum(calc?.['4H_EMA快']);
          const s = toNum(calc?.['4H_EMA慢']);
          const adx = toNum(calc?.['4H_ADX']);
          const level = toNum(calc?.['突破位']);
          const close = toNum(calc?.['收盘']);
          const high = toNum(calc?.['高']);
          const low = toNum(calc?.['低']);
          const tol = toNum(calc?.['容差']);
          const items = [];
          if (side && f != null && s != null) {
            const pass = side === 'short' ? f < s : f > s;
            items.push({ label: 'EMA方向', status: pass ? 'pass' : 'fail', value: '快' + f.toFixed(0) + ' / 慢' + s.toFixed(0) });
          }
          if (adx != null) items.push({ label: 'ADX', status: adx >= 15 ? 'pass' : 'fail', value: adx.toFixed(1) + ' vs 15' });
          if (side && level != null && close != null) {
            const pass = side === 'short' ? close < level : close > level;
            items.push({ label: '收盘确认', status: pass ? 'pass' : 'fail', value: close.toFixed(0) + ' / ' + level.toFixed(0) });
          }
          if (side && level != null && tol != null && high != null && low != null) {
            const touched = side === 'short' ? (high >= level - tol) : (low <= level + tol);
            items.push({ label: '回踩触达', status: touched ? 'pass' : 'warn', value: '容差±' + tol.toFixed(0) });
          }
          if (!items.length && planReasonText) items.push({ label: '策略理由', status: 'neutral', value: planReasonText.slice(0, 24) + '...' });
          return items;
        }
        const evidence = sigEvidence();
        const evidenceHtml = evidence.length
          ? '<div class="dt-evidence">' + evidence.map(function(it) { return '<span class="dt-ev ' + it.status + '">' + escapeHtml(it.label) + ' · ' + escapeHtml(it.value) + '</span>'; }).join('') + '</div>'
          : '';

        const signalStatus = hasAlert ? 'pass' : 'fail';
        const signalDesc = hasAlert
          ? ('识别到 ' + (planSide === 'long' ? '做多' : planSide === 'short' ? '做空' : '交易') + (planLevel ? ('（' + planLevel + '）') : '') + ' 计划')
          : (r?.signal?.note || '策略未产出可执行计划');
        const signalExtra = planReasonText || (r?.signal?.note ? String(r.signal.note) : '');
        const newsStatus = !hasAlert ? 'neutral' : (newsBlocked ? 'fail' : 'pass');
        const newsDesc = !hasAlert ? '无交易计划，新闻门控未触发' : (newsBlocked ? '新闻风控判定为阻断' : '新闻风控放行');
        const newsExtra = newsBlocked ? (newsReasonText || '检测到负面新闻因素') : '未命中新闻拦截条件';

        let riskStatus = 'neutral';
        let riskDesc = '未进入执行器风控检查';
        let riskExtra = '';
        if (hasAlert) {
          if (!e) { riskStatus = 'neutral'; riskDesc = '执行器未返回状态'; }
          else if (executed || dryRunOpen) { riskStatus = 'pass'; riskDesc = '风控检查通过'; riskExtra = execReasonText || '满足开仓条件'; }
          else if (skipped) { riskStatus = 'fail'; riskDesc = '执行前风控拦截'; riskExtra = execReasonText || execReasonRaw || '未通过执行条件'; }
          else { riskStatus = 'warn'; riskDesc = '执行器返回未知状态'; riskExtra = execReasonText || execReasonRaw || ''; }
        }
        const resultStatus = executed ? 'pass' : (dryRunOpen ? 'warn' : (skipped ? 'fail' : 'neutral'));
        const resultDesc = executed
          ? '订单已提交到交易所'
          : (dryRunOpen ? '仅模拟开仓，不会真实下单' : (skipped ? '本轮未执行下单' : '暂无执行结果'));
        const resultExtra = execReasonText || execReasonRaw || '';

        const stages = [
          { key: 'signal', short: '信号', label: '信号识别', status: signalStatus, desc: signalDesc, extra: signalExtra, extraHtml: evidenceHtml },
          { key: 'news', short: '新闻', label: '新闻门控', status: newsStatus, desc: newsDesc, extra: newsExtra },
          { key: 'risk', short: '风控', label: '账户风控', status: riskStatus, desc: riskDesc, extra: riskExtra },
          { key: 'exec', short: '执行', label: '执行结果', status: resultStatus, desc: resultDesc, extra: resultExtra },
        ];
        const blockerIdx = stages.findIndex(s => s.status === 'fail');
        const nodes = stages.map(function(stage, idx) { return nodeHtml(idx + 1, stage, idx, blockerIdx); });

        const idealFlow = stages.map(function(stage) { return flowStep(stage.short, 'pass', '通过'); }).join('');
        const actualFlow = stages.map(function(stage, idx) {
          if (blockerIdx >= 0 && idx > blockerIdx) return flowStep(stage.short, 'skip', '跳过');
          return flowStep(stage.short, stage.status, statusLabel(stage.status));
        }).join('');
        const pathCompareHtml = '<details class="fold"><summary>路径对比（候选 vs 实际）</summary><div class="fold-body"><div class="path-compare">' +
          '<div class="path-track"><div class="path-track-head"><span>候选路径（理想）</span><span>全链路通过</span></div><div class="path-steps">' + idealFlow + '</div></div>' +
          '<div class="path-track"><div class="path-track-head"><span>实际路径（本单）</span><span>' + escapeHtml(blockerIdx >= 0 ? ('在「' + stages[blockerIdx].short + '」节点阻断') : '全链路放行') + '</span></div><div class="path-steps">' + actualFlow + '</div></div>' +
        '</div></div></details>';

        const signalScore = hasAlert ? (planLevel === 'very-strong' ? 90 : 74) : 18;
        const newsRiskScore = newsBlocked ? 92 : ((Array.isArray(r?.decision?.newsItems) && r.decision.newsItems.length) ? 42 : 28);
        const riskPressureScore = (hasAlert && skipped && !newsBlocked) ? 86 : ((hasAlert && dryRunOpen) ? 58 : ((hasAlert && executed) ? 44 : 24));
        const execReadyScore = executed ? 95 : (dryRunOpen ? 68 : (hasAlert ? 30 : 12));
        const impactPanel = '<details class="fold"><summary>影响因子评分</summary><div class="fold-body"><div class="impact-panel">' +
          '<div class="impact-title">评分越高越强（阈值白线）</div>' +
          '<div class="impact-item"><div class="impact-meta"><span class="impact-name">信号强度</span><span class="impact-score">' + signalScore + '/100</span></div><div class="impact-bar"><span class="impact-fill pass" style="width:' + signalScore + '%"></span><span class="impact-threshold" style="left:55%"></span></div><div class="impact-rule">&gt;=55 继续</div></div>' +
          '<div class="impact-item"><div class="impact-meta"><span class="impact-name">新闻风险</span><span class="impact-score">' + newsRiskScore + '/100</span></div><div class="impact-bar"><span class="impact-fill ' + (newsRiskScore > 70 ? 'fail' : 'pass') + '" style="width:' + newsRiskScore + '%"></span><span class="impact-threshold" style="left:70%"></span></div><div class="impact-rule">&lt;=70 放行</div></div>' +
          '<div class="impact-item"><div class="impact-meta"><span class="impact-name">风控压力</span><span class="impact-score">' + riskPressureScore + '/100</span></div><div class="impact-bar"><span class="impact-fill ' + (riskPressureScore > 75 ? 'fail' : 'pass') + '" style="width:' + riskPressureScore + '%"></span><span class="impact-threshold" style="left:75%"></span></div><div class="impact-rule">&lt;=75 放行</div></div>' +
          '<div class="impact-item"><div class="impact-meta"><span class="impact-name">执行就绪</span><span class="impact-score">' + execReadyScore + '/100</span></div><div class="impact-bar"><span class="impact-fill ' + (execReadyScore >= 60 ? 'pass' : 'warn') + '" style="width:' + execReadyScore + '%"></span><span class="impact-threshold" style="left:60%"></span></div><div class="impact-rule">&gt;=60 执行</div></div>' +
        '</div></div></details>';

        const orderState = !order ? '无关联订单' : (order.closeTs ? '已平仓' : '持仓中');
        const orderSide = order?.side === 'long' ? '做多' : order?.side === 'short' ? '做空' : '-';
        const orderOpen = order?.openTs ? fmtTsShort(order.openTs) : '-';
        const orderClose = order?.closeTs ? fmtTsShort(order.closeTs) : '-';
        const orderPnl = Number(order?.pnlEstUSDT);
        const orderPnlTxt = Number.isFinite(orderPnl) ? ((orderPnl >= 0 ? '+' : '') + orderPnl.toFixed(2) + ' U') : '-';
        const orderDur = Number(order?.durationMin);
        const orderDurTxt = Number.isFinite(orderDur) ? (orderDur.toFixed(0) + ' 分钟') : '-';

        const blockTitle = blockerIdx >= 0 ? ('阻断节点：' + stages[blockerIdx].label) : (resultStatus === 'warn' ? '流程告警：观察态' : '流程通过：无阻断');
        const blockDesc = blockerIdx >= 0 ? (stages[blockerIdx].extra || stages[blockerIdx].desc || '触发阻断') : (resultStatus === 'warn' ? '当前为 dry-run 或策略观察态，不会真实下单。' : '所有关键关口均已放行。');

        const sidePanelHtml = '<div class="decision-side">' +
          '<div class="block-cause"><div class="bc-title">当前关键结论</div><div class="bc-main">' + escapeHtml(blockTitle) + '</div><div class="bc-desc">' + escapeHtml(blockDesc) + '</div></div>' +
          '<div class="block-cause"><div class="bc-title">关联订单</div><div class="bc-main">' + escapeHtml(orderState) + '</div><div class="bc-desc">' + escapeHtml(orderSide + ' · 开 ' + orderOpen + (order?.closeTs ? (' · 平 ' + orderClose) : '')) + '</div></div>' +
          impactPanel +
        '</div>';
        const treeMainHtml = '<div class="decision-tree-main">' +
          '<div class="decision-tree-head"><div class="decision-tree-title">决策流程图</div><div class="decision-tree-sub">Signal → News → Risk → Execute</div></div>' +
          '<div class="decision-tree">' + nodes.map(function(n, i) { return n + (i < nodes.length - 1 ? '<div class="dt-arrow">➜</div>' : ''); }).join('') + '</div>' +
          pathCompareHtml +
        '</div>';
        const treeHtml = '<div class="decision-tree-wrap"><div class="decision-tree-grid">' + treeMainHtml + sidePanelHtml + '</div></div>';

        const strategyDoc = '' +
          '<div class="strategy-block"><div class="strategy-name">策略一：突破回踩</div><div class="strategy-indicators">指标：4H EMA快/慢、4H ADX、1H ATR、突破位、容差</div><div class="strategy-apply">触发：突破后回踩到突破位±容差，并收盘重新确认方向。</div></div>' +
          '<div class="strategy-block"><div class="strategy-name">策略二：趋势再入</div><div class="strategy-indicators">指标：1H EMA20、1H ATR、容差</div><div class="strategy-apply">触发：趋势中回踩 EMA20，在容差范围内触及并收盘确认。</div></div>';
        var algoDetails = strategyDoc;
        if (calc && typeof calc === 'object') {
          var rows = Object.keys(calc).map(function(k) {
            var v = calc[k];
            var vStr = typeof v === 'number' ? (Number.isInteger(v) ? String(v) : v.toFixed(2)) : String(v);
            return '<span class="calc-k clickable" data-calc-key="' + escapeHtml(k) + '" data-calc-value="' + escapeHtml(vStr) + '" title="点击查看计算过程">' + escapeHtml(k) + '</span><span class="calc-v">' + escapeHtml(vStr) + '</span>';
          }).join('');
          algoDetails += '<div class="algo-line">本单关键指标（点击名称可查看算法说明）</div><div class="calc-grid">' + rows + '</div><div class="chart-lines-hint">图中横线为突破位 / EMA / 容差上下界</div>';
        } else if (planReasonText) {
          algoDetails += '<div class="algo-line">' + escapeHtml(planReasonText) + '</div>';
        }

        var newsLinkHtml = '';
        if (r.decision && Array.isArray(r.decision.newsItems) && r.decision.newsItems.length) {
          newsLinkHtml = r.decision.newsItems.map(function(it) {
            var u = (it && it.url) ? String(it.url) : '';
            if (!u) return '';
            var t = (it && it.title) ? escapeHtml(it.title) : '';
            var lab = (it && it.tsLocal) ? escapeHtml(it.tsLocal) + ' ' + t : t;
            return '<a class="news-link" href="' + escapeHtml(u) + '" target="_blank" rel="noopener">' + lab + '</a>';
          }).filter(Boolean).join('');
        }

        const signalLevelText = hasAlert ? ((planSide === 'long' ? '做多' : planSide === 'short' ? '做空' : '信号') + (planLevel ? (' · ' + planLevel) : '')) : '无信号';
        const resultText = executed ? '已下单' : (dryRunOpen ? 'Dry-run 会开仓' : (skipped ? '未下单' : '-'));
        var summaryRow = '<div class="summary-row">' +
          '<span class="summary-chip"><span class="summary-chip k">信号</span><span class="badge ' + (hasAlert ? (planSide === 'short' ? 'no' : 'yes') : 'no') + '">' + escapeHtml(signalLevelText) + '</span></span>' +
          '<span class="summary-chip"><span class="summary-chip k">新闻</span><span class="badge ' + (newsBlocked ? 'no' : 'yes') + '">' + (newsBlocked ? '拦截' : '放行') + '</span></span>' +
          '<span class="summary-chip"><span class="summary-chip k">结果</span><span class="badge ' + (executed ? 'yes' : (dryRunOpen ? 'dry' : 'no')) + '">' + escapeHtml(resultText) + '</span></span>' +
          '<span class="summary-chip"><span class="summary-chip k">订单</span><span class="badge ' + (order?.closeTs ? 'yes' : (order ? 'dry' : 'no')) + '">' + escapeHtml(orderState) + '</span></span>' +
        '</div>';

        var primaryReason = planReasonText || (hasAlert ? (r?.signal?.note || '策略给出信号，但未附可读理由。') : '本轮无交易计划。');
        var finalReason = execReasonText || execReasonRaw || (executed ? '执行成功' : (skipped ? '未满足执行条件' : '无'));
        var orderActionBtn = order?.tradeId
          ? '<button class="order-focus-btn" type="button" data-trade-id="' + escapeHtml(String(order.tradeId)) + '">高亮这笔开平区间</button>'
          : '';
        var reasonPanel = '<details class="fold" open><summary>一眼看懂：核心原因</summary><div class="fold-body"><div class="logic-result-block"><strong>为什么会这样决策：</strong>' + escapeHtml(primaryReason) + '<br/><strong>为什么是这个结果：</strong>' + escapeHtml(finalReason) + '</div></div></details>';
        var orderPanel = '<details class="fold" open><summary>订单关联（买/卖时序）</summary><div class="fold-body"><div class="compact-kv">' +
          '<div class="k">状态</div><div class="v">' + escapeHtml(orderState + (order?.isSynthetic ? '（模拟）' : '')) + '</div>' +
          '<div class="k">方向</div><div class="v">' + escapeHtml(orderSide) + '</div>' +
          '<div class="k">开仓</div><div class="v">' + escapeHtml(orderOpen) + '</div>' +
          '<div class="k">平仓</div><div class="v">' + escapeHtml(orderClose) + '</div>' +
          '<div class="k">盈亏</div><div class="v">' + escapeHtml(orderPnlTxt) + '</div>' +
          '<div class="k">持仓时长</div><div class="v">' + escapeHtml(orderDurTxt) + '</div>' +
        '</div>' + orderActionBtn + '</div></details>';
        var metricsPanel = '<details class="fold"><summary>策略与指标详情</summary><div class="fold-body">' + algoDetails + '</div></details>';
        var newsPanel = newsLinkHtml
          ? '<details class="fold"><summary>新闻源（可点击跳转）</summary><div class="fold-body"><div class="news-list-wrap">' + newsLinkHtml + '</div><div class="popover-pin-hint">提示：点击图表固定弹窗后再打开链接更顺手。</div></div></details>'
          : '';
        var rawPanel = '<details class="fold"><summary>执行字段与原始状态</summary><div class="fold-body"><div class="compact-kv">' +
          '<div class="k">cycleId</div><div class="v">' + escapeHtml(r?.cycleId || '-') + '</div>' +
          '<div class="k">计划</div><div class="v">' + escapeHtml(p ? ((p.side || '-') + ' / ' + (p.level || '-')) : 'none') + '</div>' +
          '<div class="k">执行器 reason</div><div class="v">' + escapeHtml(execReasonRaw || '-') + '</div>' +
          '<div class="k">日内PnL</div><div class="v">' + (e && e.dailyRealizedPnlUSDT != null ? escapeHtml(String(e.dailyRealizedPnlUSDT) + ' USDT') : '-') + '</div>' +
        '</div></div></details>';

        return '<button class="popover-close" type="button" aria-label="关闭">&times;</button>' +
          '<div class="popover-ts">' + ts + '</div>' +
          summaryRow +
          treeHtml +
          reasonPanel +
          orderPanel +
          metricsPanel +
          newsPanel +
          rawPanel;
      }
      var currentPopoverRecord = null;
      var popoverPinned = false;
      popover.addEventListener('click', function(e) {
        if (e.target.classList.contains('popover-close')) {
          popoverPinned = false;
          hidePopover();
          return;
        }
        var orderBtn = e.target.closest && e.target.closest('[data-trade-id]');
        if (orderBtn) {
          e.preventDefault();
          e.stopPropagation();
          var order = findOrderByTradeId(orderBtn.getAttribute('data-trade-id'));
          if (order) setActiveOrder(order, { focus: true });
        }
      });
      var calcTooltipTimer = null;
      var calcTooltipPinned = false;
      var miniChartInstance = null;
      var hoverTooltip = document.getElementById('indicator-hover-tooltip');
      function hideCalcTooltip() {
        calcTooltipPinned = false;
        hoverTooltip.classList.remove('visible', 'pinned');
        hoverTooltip.style.pointerEvents = '';
        if (miniChartInstance) { try { miniChartInstance.remove(); } catch (_) {} miniChartInstance = null; }
      }
      function showCalcTooltip(el, isPinned) {
        if (!el || !el.getAttribute('data-calc-key')) return;
        if (calcTooltipTimer) { clearTimeout(calcTooltipTimer); calcTooltipTimer = null; }
        if (miniChartInstance) { try { miniChartInstance.remove(); } catch (_) {} miniChartInstance = null; }
        var key = el.getAttribute('data-calc-key'), val = el.getAttribute('data-calc-value') || '';
        var explain = getIndicatorExplain(key);
        var steps = (explain.steps && explain.steps.length) ? explain.steps.map(function(s, i) { return '<div class="calc-tt-step">' + (i + 1) + '. ' + escapeHtml(s) + '</div>'; }).join('') : '';
        hoverTooltip.innerHTML = '<div class="calc-tt-title">' + escapeHtml(key) + '</div><div class="calc-tt-value">本单数值：' + escapeHtml(val) + '</div><div class="calc-tt-steps">' + steps + '</div><div class="calc-tt-formula">' + escapeHtml(explain.formula) + '</div><div class="calc-tt-chart">' + escapeHtml(explain.chartHint) + '</div><div class="calc-tt-minichart" id="calc-tt-minichart"></div><button type="button" class="calc-tt-close">点击关闭</button>';
        var chartWrap = document.getElementById('calc-tt-minichart');
        var tf = (key.indexOf('4H') === 0) ? '4h' : '1h';
        var ohlcv = OHLCV_BY_TF[tf] || [];
        if (chartWrap && ohlcv.length > 0 && typeof LightweightCharts !== 'undefined') {
          var decisionTs = currentPopoverRecord && currentPopoverRecord.ts ? new Date(currentPopoverRecord.ts).getTime() / 1000 : 0;
          var tfSec = TF_SECONDS[tf] || 3600;
          var barT = Math.floor(decisionTs / tfSec) * tfSec;
          var idx = ohlcv.findIndex(function(b) { return b.time >= barT; });
          if (idx < 0) idx = ohlcv.length - 1;
          var from = Math.max(0, idx - 22);
          var slice = ohlcv.slice(from, idx + 6);
          try {
            miniChartInstance = LightweightCharts.createChart(chartWrap, { width: 256, height: 72, layout: { background: { type: 'solid', color: 'rgba(0,0,0,0.2)' }, textColor: '#8b949e' }, grid: { vertLines: { visible: false }, horzLines: { visible: false } }, rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.1, bottom: 0.1 } }, timeScale: { borderVisible: false, timeVisible: true, secondsVisible: false } });
            var series = miniChartInstance.addCandlestickSeries({ upColor: '#3fb950', downColor: '#f85149', borderVisible: false });
            series.setData(slice);
            miniChartInstance.timeScale().fitContent();
          } catch (err) {}
        }
        if (isPinned) { calcTooltipPinned = true; hoverTooltip.classList.add('pinned'); hoverTooltip.style.pointerEvents = 'auto'; }
        hoverTooltip.classList.add('visible');
        var rect = el.getBoundingClientRect();
        var left = rect.right + 8, top = rect.top;
        if (left + 280 > window.innerWidth) left = rect.left - 288;
        var h = hoverTooltip.offsetHeight || 220;
        if (top + h > window.innerHeight - 8) top = window.innerHeight - h - 8;
        if (top < 8) top = 8;
        hoverTooltip.style.left = left + 'px'; hoverTooltip.style.top = top + 'px';
        hoverTooltip.querySelector('.calc-tt-close').onclick = function() { hideCalcTooltip(); };
      }
      popover.addEventListener('mouseover', function(e) {
        if (calcTooltipPinned) return;
        var el = e.target.closest && e.target.closest('.calc-k.clickable');
        if (el && el.getAttribute('data-calc-key')) showCalcTooltip(el, false);
      });
      popover.addEventListener('mouseout', function(e) {
        var el = e.target.closest && e.target.closest('.calc-k.clickable');
        var rel = e.relatedTarget && e.relatedTarget.closest && e.relatedTarget.closest('.calc-k.clickable');
        if (el && !rel && !calcTooltipPinned) calcTooltipTimer = setTimeout(hideCalcTooltip, 120);
      });
      popover.addEventListener('click', function(e) {
        var el = e.target.closest && e.target.closest('.calc-k.clickable');
        if (el && el.getAttribute('data-calc-key')) { e.preventDefault(); e.stopPropagation(); showCalcTooltip(el, true); }
      });
      document.addEventListener('click', function(e) {
        if (calcTooltipPinned && hoverTooltip && !hoverTooltip.contains(e.target) && !popover.contains(e.target)) hideCalcTooltip();
      });
      function showPopoverAt(record, clientX, clientY) {
        currentPopoverRecord = record;
        const rect = chartWrap.getBoundingClientRect();
        popover.innerHTML = renderDetailCard(record);
        popover.classList.add('visible');
        applyDecisionPriceLines(record);
        popover.style.right = '';
        popover.style.bottom = '';
        popover.style.width = '';
        var left = clientX - rect.left + 12, top = clientY - rect.top - 8;
        if (left + 320 > rect.width) left = rect.width - 330;
        if (top < 8) top = 8;
        if (top + 280 > rect.height) top = rect.height - 290;
        popover.style.left = left + 'px'; popover.style.top = top + 'px';
      }
      function showPopoverPinned(record) {
        currentPopoverRecord = record;
        const rect = chartWrap.getBoundingClientRect();
        popover.innerHTML = renderDetailCard(record);
        popover.classList.add('visible');
        applyDecisionPriceLines(record);
        if (isTouchDevice) {
          popover.style.left = '8px';
          popover.style.right = '8px';
          popover.style.bottom = '8px';
          popover.style.top = 'auto';
          popover.style.width = 'auto';
        } else {
          popover.style.right = '';
          popover.style.bottom = '';
          popover.style.width = '';
          popover.style.left = Math.max(8, rect.width - 340) + 'px';
          popover.style.top = '8px';
        }
        popoverPinned = true;
      }
      function hidePopover() { popoverPinned = false; clearDecisionPriceLines(); popover.classList.remove('visible'); if (typeof hideCalcTooltip === 'function') hideCalcTooltip(); }
      function getRecordAtCoord(x, fuzzyBars) {
        const fuzz = Number.isFinite(Number(fuzzyBars)) ? Math.max(0, Number(fuzzyBars)) : 0;
        const time = chart.timeScale().coordinateToTime(x);
        if (time === null || time === undefined) return null;
        const t = typeof time === 'number' ? time : (time && time.year ? new Date(time.year, (time.month || 1) - 1, time.day || 1).getTime() / 1000 : 0);
        if (!(Number.isFinite(t) && t > 0)) return null;
        const tfSec = TF_SECONDS[currentTf] || 3600;
        const barStart = Math.floor(t / tfSec) * tfSec, barEnd = barStart + tfSec;
        const inWindow = (ts, bStart, bEnd) => ts >= bStart && ts < bEnd;
        let matched = RECORDS_WITH_TS.filter(x => inWindow(x.tsSec, barStart, barEnd));
        if (!matched.length && fuzz > 0) {
          for (let d = 1; d <= fuzz; d++) {
            const leftStart = barStart - d * tfSec;
            const leftEnd = barEnd - d * tfSec;
            const rightStart = barStart + d * tfSec;
            const rightEnd = barEnd + d * tfSec;
            matched = RECORDS_WITH_TS.filter(x => inWindow(x.tsSec, leftStart, leftEnd) || inWindow(x.tsSec, rightStart, rightEnd));
            if (matched.length) break;
          }
        }
        return matched.length ? matched[matched.length - 1].r : null;
      }
      let hidePopoverTimer = null;
      chart.subscribeCrosshairMove(function(param) {
        if (isTouchDevice || popoverPinned) return;
        const rect = chartWrap.getBoundingClientRect();
        if (!param.point) { if (hidePopoverTimer) clearTimeout(hidePopoverTimer); hidePopoverTimer = setTimeout(hidePopover, 80); return; }
        if (hidePopoverTimer) { clearTimeout(hidePopoverTimer); hidePopoverTimer = null; }
        const record = getRecordAtCoord(param.point.x, 0);
        if (!record) { hidePopover(); return; }
        showPopoverAt(record, rect.left + param.point.x, rect.top + param.point.y);
      });
      popover.addEventListener('mouseenter', function() { if (hidePopoverTimer) { clearTimeout(hidePopoverTimer); hidePopoverTimer = null; } });
      chart.subscribeClick(function(param) {
        if (!param.point) return;
        const record = getRecordAtCoord(param.point.x, isTouchDevice ? 2 : 1);
        if (record) {
          showPopoverPinned(record);
          const order = findOrderForRecord(record);
          if (order) setActiveOrder(order);
          else setActiveOrder(null);
        }
        const time = chart.timeScale().coordinateToTime(param.point.x);
        if (time == null) return;
        const t = typeof time === 'number' ? time : (time && time.year ? new Date(time.year, (time.month || 1) - 1, time.day || 1).getTime() / 1000 : 0);
        const tfSec = TF_SECONDS[currentTf] || 3600, barStart = Math.floor(t / tfSec) * tfSec;
        const idx = currentOhlcv.findIndex(c => c.time >= barStart);
        if (idx >= 0) chart.timeScale().setVisibleLogicalRange({ from: Math.max(0, idx - 15), to: Math.min(currentOhlcv.length, idx + 10) });
      });
      chartWrap.addEventListener('mouseleave', function(e) { if (!popoverPinned && (!e.relatedTarget || !popover.contains(e.relatedTarget))) hidePopover(); });
      popover.addEventListener('mouseleave', function(e) { if (!popoverPinned && (!e.relatedTarget || !chartWrap.contains(e.relatedTarget))) hidePopover(); });
      document.addEventListener('click', function(e) {
        if (popoverPinned && !popover.contains(e.target) && !chartWrap.contains(e.target) && !(hoverTooltip && hoverTooltip.contains(e.target))) { popoverPinned = false; hidePopover(); }
      });

      const tbody = document.getElementById('tbody');
      const tableTotal = document.getElementById('table-total');
      const pageIndicator = document.getElementById('page-indicator');
      const pagePrev = document.getElementById('page-prev');
      const pageNext = document.getElementById('page-next');
      const filterExecuted = document.getElementById('filter-executed');
      const filterSkipped = document.getElementById('filter-skipped');
      const filterSignal = document.getElementById('filter-signal');
      const filterErrors = document.getElementById('filter-errors');
      const PAGE_SIZE = isTouchDevice ? 12 : 20;
      let currentPage = 1;
      function row(r, index) {
        const isErr = !r.ok || r.stage;
        const order = findOrderForRecord(r);
        const tradeId = order?.tradeId != null ? String(order.tradeId) : '';
        const classList = [];
        if (isErr) classList.push('error-row');
        if (activeOrderTradeId && tradeId && tradeId === activeOrderTradeId) classList.push('order-focus-row');
        const cls = classList.join(' ');
        const ts = r.ts ? new Date(r.ts).toLocaleString('zh-CN', { hour12: false }) : '-';
        const tsAttr = r.ts ? ' data-ts="' + escapeHtml(r.ts) + '"' : '';
        const tradeAttr = tradeId ? (' data-trade-id="' + escapeHtml(tradeId) + '"') : '';
        let signal = '-';
        if (r.signal) { signal = (r.signal.hasAlert ? '<span class="badge yes">有</span>' : '<span class="badge no">无</span>') + (r.signal.note ? '<span class="detail">' + escapeHtml(r.signal.note) + '</span>' : ''); } else if (r.error) signal = '<span class="badge no">' + escapeHtml(r.error) + '</span>';
        let plan = '-';
        if (r.signal?.plan) { const p = r.signal.plan; plan = '<span class="badge ' + (p.side === 'long' ? 'yes' : 'no') + '">' + escapeHtml(p.side) + '</span> ' + escapeHtml(p.level || ''); if (p.reason) plan += '<div class="detail">' + escapeHtml(String(p.reason).slice(0, 100)) + '</div>'; }
        let news = r.decision ? (r.decision.blockedByNews ? '<span class="badge no">拦截</span>' + (r.decision.newsReason?.length ? '<div class="detail">' + escapeHtml(r.decision.newsReason.slice(0, 2).join('; ')) + '</div>' : '') : '<span class="badge yes">放行</span>') : '-';
        let exec = '-', reason = '-';
        if (r.executor) { const e = r.executor; if (e.executed) exec = '<span class="badge yes">已下单</span>'; else if (e.dryRun && (e.wouldOpenPosition || e.reason === 'dry_run_open')) exec = '<span class="badge dry">Dry-run 会开仓</span>'; else if (e.skipped) exec = '<span class="badge no">未下单</span>'; reason = e.reason ? escapeHtml(e.reason) : '-'; if (e.dailyRealizedPnlUSDT != null) reason += ' <span class="detail">日盈亏 ' + Number(e.dailyRealizedPnlUSDT).toFixed(2) + ' USDT</span>'; } else if (r.error) reason = escapeHtml(r.error);
        const relation = orderRelationHtml(order);
        return '<tr class="' + cls + '" data-index="' + index + '"' + tsAttr + tradeAttr + '><td class="ts" data-label="时间">' + ts + '</td><td data-label="信号">' + signal + '</td><td data-label="计划">' + plan + '</td><td data-label="新闻">' + news + '</td><td data-label="执行">' + exec + '</td><td data-label="关联订单">' + relation + '</td><td class="reason" data-label="原因">' + reason + '</td></tr>';
      }
      function render() {
        let list = RECORDS.slice().reverse();
        if (filterExecuted.checked) list = list.filter(r => r.executor?.executed);
        if (filterSkipped.checked) list = list.filter(r => r.executor?.skipped);
        if (filterSignal.checked) list = list.filter(r => r.signal?.hasAlert && !r.executor?.executed);
        if (filterErrors.checked) list = list.filter(r => !r.ok || r.stage);
        const total = list.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        if (tableTotal) tableTotal.textContent = '共 ' + total + ' 条';
        if (pageIndicator) pageIndicator.textContent = currentPage + ' / ' + totalPages;
        if (pagePrev) pagePrev.disabled = currentPage <= 1;
        if (pageNext) pageNext.disabled = currentPage >= totalPages;

        if (total === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty">无记录或过滤后为空</td></tr>'; return; }
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageList = list.slice(start, start + PAGE_SIZE);
        tbody.innerHTML = pageList.map((r, i) => row(r, start + i)).join('');
        function barIndexForTime(tsStr) { const t = Math.floor(new Date(tsStr).getTime() / 1000); for (let i = currentOhlcv.length - 1; i >= 0; i--) if (currentOhlcv[i].time <= t) return i; return 0; }
        tbody.querySelectorAll('.order-focus-btn[data-trade-id]').forEach(btn => {
          btn.addEventListener('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            const order = findOrderByTradeId(btn.getAttribute('data-trade-id'));
            if (order) setActiveOrder(order, { focus: true });
          });
        });
        tbody.querySelectorAll('tr[data-ts]').forEach(tr => {
          tr.addEventListener('click', () => {
            tbody.querySelectorAll('tr').forEach(t => t.classList.remove('highlight'));
            tr.classList.add('highlight');
            const ts = tr.getAttribute('data-ts');
            if (!ts) return;
            const idx = barIndexForTime(ts);
            chart.timeScale().setVisibleLogicalRange({ from: Math.max(0, idx - 25), to: Math.min(currentOhlcv.length, idx + 8) });
            const record = RECORDS.find(r => r && r.ts === ts && !r.stage);
            if (record) {
              showPopoverPinned(record);
              const order = findOrderForRecord(record);
              if (order) setActiveOrder(order, { focus: true });
              else setActiveOrder(null);
            }
          });
        });
        syncOrderHighlightRows();
      }
      if (pagePrev) pagePrev.addEventListener('click', () => { if (currentPage > 1) { currentPage -= 1; render(); } });
      if (pageNext) pageNext.addEventListener('click', () => { currentPage += 1; render(); });
      [filterExecuted, filterSkipped, filterSignal, filterErrors].filter(Boolean).forEach(el => el.addEventListener('change', () => { currentPage = 1; render(); }));
      render();
      renderHistoryOrders();
      renderDashboard();
      switchView('dashboard');
    }

    registerPwaServiceWorker();
    setupPwaInstall();
    load().catch(e => showLoadError(e && e.message));
  </script>
</body>
</html>